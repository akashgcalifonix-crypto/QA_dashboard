<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>PQC Dashboard System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Charts -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
/* --- CORE STYLES --- */
:root {
    --primary: #2563eb;
    --dark: #1e293b;
    --bg: #f1f5f9;
    --card-bg: #ffffff;
    --ref-blue: #3b82f6;
    --ref-red: #ef4444;
    --ref-green: #10b981; 
}

body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--dark); }

/* --- HEADER --- */
.header-box {
    background: white; padding: 15px 25px; border-radius: 12px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 5px solid var(--primary);
}
.app-logo { height: 45px; }
.app-title { font-size: 20px; font-weight: 700; margin-left: 15px; }

/* --- MAIN NAV TABS --- */
.nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; background: #e2e8f0; padding: 5px; border-radius: 30px; width: fit-content; margin: 0 auto 25px auto; }
.tab-btn {
    padding: 10px 25px; border: none; border-radius: 25px; cursor: pointer;
    font-weight: 600; color: #64748b; background: transparent; transition: 0.3s;
}
.tab-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3); }

/* Dashboard Styles */
.tab-content { display: none; animation: fadeIn 0.4s; }
.tab-content.active { display: block; }
.card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }

.dash-top-bar {
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03);
}
.date-filter-box { display: flex; gap: 10px; align-items: center; background: #f8fafc; padding: 8px 15px; border-radius: 8px; border: 1px solid #cbd5e1; }
.date-input { border: none; background: transparent; font-family: 'Poppins'; font-size: 13px; color: #333; outline: none; }

.floor-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
.ft-btn {
    flex: 1; padding: 12px; border: 1px solid #e2e8f0; background: white; border-radius: 8px;
    cursor: pointer; font-weight: 600; text-align: center; transition: 0.2s; color: #64748b;
}
.ft-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

.d-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
.d-kpi-card { padding: 20px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.bg-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.bg-green { background: linear-gradient(135deg, #10b981, #059669); }
.bg-red { background: linear-gradient(135deg, #f43f5e, #e11d48); }
.bg-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.dk-val { font-size: 28px; font-weight: 700; } .dk-lbl { font-size: 12px; opacity: 0.9; text-transform: uppercase; }

.d-charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
.d-chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.chart-h { font-size: 14px; font-weight: 700; margin-bottom: 15px; color: #334155; border-left: 4px solid var(--primary); padding-left: 10px; }
#d_pie, #d_bar { width: 100%; height: 250px; }

/* Table Styles */
.table-responsive { overflow-x: auto; }
.table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
.table th { background: #f8fafc; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
.table td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

/* Forms */
.form-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
.form-group { display: flex; flex-direction: column; flex: 1; min-width: 140px; }
input, select { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: 'Poppins'; outline: none; }
button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: var(--primary); color: white; }

/* Record Summary Preview Cards */
.rec-preview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
.rec-pre-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center; border-bottom: 4px solid #cbd5e1; }
.rpc-lbl { font-size: 11px; color: #64748b; font-weight: 600; margin-bottom: 5px; }
.rpc-val { font-size: 20px; font-weight: 800; color: #1e293b; }
.c-blue { border-bottom-color: var(--ref-blue); } .c-red { border-bottom-color: var(--ref-red); } .c-green { border-bottom-color: var(--ref-green); } .c-purple { border-bottom-color: #8b5cf6; }

/* Modal Styles */
.overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); z-index: 999; }
.modal-lg { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 1000px; background: #fff; border-radius: 8px; z-index: 1000; box-shadow: 0 25px 50px rgba(0,0,0,0.4); overflow: hidden; animation: slideUp 0.3s; }
.pv-header { background: #fff; padding: 15px 25px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
.pv-title { font-size: 22px; font-weight: 800; color: #1e293b; }
.pv-body { padding: 25px; max-height: 85vh; overflow-y: auto; }
.pv-info-strip { display: flex; background: #f8fafc; border-radius: 8px; margin-bottom: 25px; border: 1px solid #e2e8f0; }
.pv-info-item { flex: 1; text-align: center; padding: 12px 5px; border-right: 1px solid #e2e8f0; }
.pv-lbl { font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
.pv-val { font-size: 15px; font-weight: 700; color: #0f172a; }

@keyframes slideUp { from { transform: translate(-50%, -45%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<div class="header-box">
    <div style="display:flex; align-items:center;">
        <img id="mainLogo" src="" class="app-logo"> 
        <div class="app-title">PQC Performance Dashboard</div>
    </div>
    <div style="font-size:12px; color:#64748b;">Date: <span id="curDate"></span></div>
</div>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
    <button class="tab-btn" onclick="switchTab('entry')">üìù Data Entry</button>
    <button class="tab-btn" onclick="switchTab('report')">üìÇ Records</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="tab-content active">
    <div class="dash-top-bar">
        <h3 style="margin:0;">Production Dashboard</h3>
        <div style="display:flex; gap:10px;">
            <div class="date-filter-box">FROM <input type="date" id="dash_from" class="date-input"></div>
            <div class="date-filter-box">TO <input type="date" id="dash_to" class="date-input"></div>
            <button onclick="filterDashboard()">Filter</button>
        </div>
    </div>
    <div class="floor-tabs">
        <div class="ft-btn active" onclick="switchDashTab('all', this)">Overall</div>
        <div class="ft-btn" onclick="switchDashTab('1', this)">1st Floor</div>
        <div class="ft-btn" onclick="switchDashTab('2', this)">2nd Floor</div>
        <div class="ft-btn" onclick="switchDashTab('b', this)">Basement</div>
    </div>
    <div id="dash_content">
        <div class="d-kpi-grid">
            <div class="d-kpi-card bg-blue"><div class="dk-val" id="d_inp">0</div><div class="dk-lbl">Input</div></div>
            <div class="d-kpi-card bg-green"><div class="dk-val" id="d_fpy">--</div><div class="dk-lbl">FPY %</div></div>
            <div class="d-kpi-card bg-red"><div class="dk-val" id="d_def">0</div><div class="dk-lbl">Defects</div></div>
            <div class="d-kpi-card bg-purple"><div class="dk-val" id="d_rej">--</div><div class="dk-lbl">Rej %</div></div>
        </div>
        <div class="d-charts-row">
            <div class="d-chart-box"><div class="chart-h">Quality Ratio</div><div id="d_pie"></div></div>
            <div class="d-chart-box"><div class="chart-h">Defect Rate %</div><div id="d_bar"></div></div>
        </div>
    </div>
</div>

<!-- ENTRY -->
<div id="entry" class="tab-content">
    <div class="card">
        <h3>üìù New PQC Entry</h3>
        <div class="form-row">
            <div class="form-group"><label>Date</label><input type="date" id="f_date"></div>
            <div class="form-group"><label>Shift</label><select id="f_shift"><option>A</option><option>B</option><option>C</option></select></div>
            <div class="form-group"><label>Line</label><input type="number" id="f_line"></div>
            <div class="form-group"><label>Model</label><input id="f_model"></div>
            <div class="form-group"><label>Input</label><input id="f_input" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Defect</label><input id="f_def" type="number" oninput="autoCalc()"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>RMD Qty</label><input id="rmd" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Proc Qty</label><input id="proc" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>SMT Qty</label><input id="smt" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Prepared By</label><input id="prep"></div>
        </div>
        <!-- Hidden/Calculated -->
        <input type="hidden" id="f_rej"> <input type="hidden" id="f_fpy">
        <input type="hidden" id="rmd_r"> <input type="hidden" id="proc_r"> <input type="hidden" id="smt_r">
        
        <h4>Top Defects</h4>
        <div class="form-row">
            <div class="form-group"><input id="d1" placeholder="Defect 1"><input id="q1" type="number" placeholder="Qty"></div>
            <div class="form-group"><input id="d2" placeholder="Defect 2"><input id="q2" type="number" placeholder="Qty"></div>
            <div class="form-group"><input id="d3" placeholder="Defect 3"><input id="q3" type="number" placeholder="Qty"></div>
        </div>
        <button onclick="saveData()" id="saveBtn" style="width:100%; height:50px;">SAVE RECORD</button>
    </div>
</div>

<!-- RECORDS -->
<div id="report" class="tab-content">
    <div class="card">
        <h3>üìÇ Records</h3>
        <div style="background:#f1f5f9; padding:15px; border-radius:10px; margin-bottom:20px;">
            <div class="form-row">
                <div class="form-group"><label>From</label><input type="date" id="date_from"></div>
                <div class="form-group"><label>To</label><input type="date" id="date_to"></div>
                <div class="form-group" style="flex:2;"><label>Lines</label><div id="lineSelectBox" style="border:1px solid #cbd5e1; background:white; padding:5px; border-radius:8px;"></div></div>
                <button onclick="applyFilters()" style="align-self: flex-end; margin-bottom: 5px;">Search</button>
            </div>
        </div>

        <!-- SEARCH PREVIEW PORTION -->
        <div id="rec_summary" class="rec-preview-grid" style="display:none;">
            <div class="rec-pre-card c-green"><div class="rpc-lbl">Avg FPY</div><div class="rpc-val" id="rp_fpy">0%</div></div>
            <div class="rec-pre-card c-red"><div class="rpc-lbl">Line Defect Rate</div><div class="rpc-val" id="rp_def">0%</div></div>
            <div class="rec-pre-card c-blue"><div class="rpc-lbl">SMT Defect Rate</div><div class="rpc-val" id="rp_smt">0%</div></div>
            <div class="rec-pre-card c-purple"><div class="rpc-lbl">RMD Defect Rate</div><div class="rpc-val" id="rp_rmd">0%</div></div>
        </div>

        <div class="table-responsive">
            <table class="table"><thead><tr id="thead"></tr></thead><tbody id="tbody"></tbody></table>
            <div id="noDataMsg" style="text-align:center; padding:20px; display:none;">No data.</div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="overlay" id="overlay"></div>
<div class="modal-lg" id="previewModal">
  <div class="pv-header"><div class="pv-title">REPORT PREVIEW</div><button onclick="closeModal()">‚úï</button></div>
  <div class="pv-body" id="previewContent"></div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxR9xw1KJjLp0HUiHqyrSHgc4Ztt4HmWYNyfy8_tp50FubEaKbL36fJMQkjKNISQ_vXCA/exec";
const LOGO_URL = "https://i.postimg.cc/kRSbTd6w/logo.png";
document.getElementById('mainLogo').src = LOGO_URL;
document.getElementById('curDate').innerText = new Date().toLocaleDateString();
google.charts.load('current', {'packages':['corechart']});

let allData = []; let editingRowIndex = null; let activeDashFloor = 'all';

function init() {
    const box = document.getElementById('lineSelectBox');
    let h = '<div style="display:flex; gap:10px; flex-wrap:wrap;">';
    for(let i=1; i<=24; i++) h += `<label style="font-size:11px;"><input type="checkbox" value="${i}" class="line-chk"> L${i}</label>`;
    box.innerHTML = h + '</div>';
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('dash_from').value = today; document.getElementById('dash_to').value = today;
}
init();

function fixDate(d) {
    if(!d) return "";
    let date = new Date(d);
    return isNaN(date.getTime()) ? d : date.toISOString().slice(0,10);
}

function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
}

function autoCalc(){
    let i = +f_input.value || 0; let d = +f_def.value || 0;
    if(i > 0){ 
        f_rej.value = ((d/i)*100).toFixed(2); f_fpy.value = (100 - (d/i*100)).toFixed(2);
        rmd_r.value = ((+rmd.value||0)/i*100).toFixed(2);
        proc_r.value = ((+proc.value||0)/i*100).toFixed(2);
        smt_r.value = ((+smt.value||0)/i*100).toFixed(2);
    }
}

async function load(){ try{ const r = await fetch(API); const j = await r.json(); allData = j.rows; applyFilters(); filterDashboard(); }catch(e){} }

// EDIT FUNCTION FIXED (Using row index instead of passing object)
function editRow(rowIndex) {
    editingRowIndex = rowIndex;
    let r = allData[rowIndex - 1]; // Because allData[0] is header
    
    f_date.value = fixDate(r[0]);
    f_shift.value = r[1];
    f_line.value = r[2];
    f_model.value = r[3];
    f_input.value = r[4];
    f_def.value = r[5];
    rmd.value = r[8];
    proc.value = r[10];
    smt.value = r[12];
    d1.value = r[14]; q1.value = r[15];
    d2.value = r[18]; q2.value = r[19];
    d3.value = r[22]; q3.value = r[23];
    prep.value = r[26];
    
    autoCalc();
    switchTab('entry');
    const b = document.getElementById("saveBtn");
    b.innerText = "UPDATE RECORD"; b.style.background = "#f59e0b";
}

async function saveData() {
    const btn = document.getElementById("saveBtn");
    const row = [f_date.value, f_shift.value, f_line.value, f_model.value, f_input.value, f_def.value, f_rej.value, f_fpy.value, rmd.value, rmd_r.value, proc.value, proc_r.value, smt.value, smt_r.value, d1.value, q1.value, "", "", d2.value, q2.value, "", "", d3.value, q3.value, "", "", prep.value];
    
    btn.innerText = "Processing..."; btn.disabled = true;
    const action = editingRowIndex ? "edit" : "append";
    try {
        await fetch(API, { method: "POST", body: JSON.stringify({ action, row, rowIndex: editingRowIndex }) });
        editingRowIndex = null;
        btn.innerText = "SAVE RECORD"; btn.style.background = "var(--primary)";
        resetForm(); load();
    } catch(e){ alert("Error saving"); } finally { btn.disabled = false; }
}

function resetForm(){ 
    document.querySelectorAll('#entry input').forEach(i => i.value = ""); 
    editingRowIndex = null;
}

function applyFilters() {
    if(!allData || allData.length < 2) return;
    const dFrom = document.getElementById("date_from").value;
    const dTo = document.getElementById("date_to").value;
    const selectedLines = Array.from(document.querySelectorAll('.line-chk:checked')).map(cb => cb.value);
    
    const tbody = document.getElementById('tbody');
    const thead = document.getElementById('thead');
    tbody.innerHTML = ""; thead.innerHTML = "";

    // Header
    allData[0].forEach(h => thead.innerHTML += `<th>${h}</th>`);
    thead.innerHTML += `<th>Action</th>`;

    let tInp = 0, tDef = 0, tSMT = 0, tRMD = 0;
    let count = 0;

    allData.slice(1).forEach((r, idx) => {
        let rDate = fixDate(r[0]);
        let rLine = r[2].toString();
        let match = true;
        if(dFrom && rDate < dFrom) match = false;
        if(dTo && rDate > dTo) match = false;
        if(selectedLines.length > 0 && !selectedLines.includes(rLine)) match = false;

        if(match) {
            count++;
            tInp += (+r[4]||0); tDef += (+r[5]||0);
            tRMD += (+r[8]||0); tSMT += (+r[12]||0);

            let tr = document.createElement("tr");
            r.forEach((cell, i) => tr.innerHTML += `<td>${i===0 ? fixDate(cell) : cell||""}</td>`);
            
            // Buttons using Index to avoid string errors
            let sRow = idx + 2; 
            tr.innerHTML += `<td>
                <button onclick="viewRow(${sRow})" style="background:#64748b; padding:5px 10px;"><i class="fa fa-eye"></i></button>
                <button onclick="editRow(${sRow})" style="background:#f59e0b; padding:5px 10px;"><i class="fa fa-edit"></i></button>
            </td>`;
            tbody.innerHTML += tr.outerHTML;
        }
    });

    // Update Record Preview Portion
    const preview = document.getElementById("rec_summary");
    if(count > 0) {
        preview.style.display = 'grid';
        let dr = tInp > 0 ? (tDef/tInp*100).toFixed(2) : 0;
        document.getElementById("rp_fpy").innerText = (100 - dr).toFixed(2) + "%";
        document.getElementById("rp_def").innerText = dr + "%";
        document.getElementById("rp_smt").innerText = (tInp > 0 ? (tSMT/tInp*100).toFixed(2) : 0) + "%";
        document.getElementById("rp_rmd").innerText = (tInp > 0 ? (tRMD/tInp*100).toFixed(2) : 0) + "%";
    } else {
        preview.style.display = 'none';
    }
}

function viewRow(idx) {
    let r = allData[idx-1];
    let content = `<div class="pv-info-strip">
        <div class="pv-info-item"><div class="pv-lbl">Line</div><div class="pv-val">${r[2]}</div></div>
        <div class="pv-info-item"><div class="pv-lbl">Model</div><div class="pv-val">${r[3]}</div></div>
        <div class="pv-info-item"><div class="pv-lbl">Input</div><div class="pv-val">${r[4]}</div></div>
        <div class="pv-info-item"><div class="pv-lbl">FPY</div><div class="pv-val">${r[7]}%</div></div>
    </div>`;
    document.getElementById("previewContent").innerHTML = content;
    document.getElementById("overlay").style.display = "block";
    document.getElementById("previewModal").style.display = "block";
}

function closeModal() {
    document.getElementById("overlay").style.display = "none";
    document.getElementById("previewModal").style.display = "none";
}

// Dashboard Stats (Simplified for performance)
function filterDashboard() {
    let rows = allData.slice(1);
    let tInp = 0, tDef = 0;
    rows.forEach(r => { tInp += (+r[4]||0); tDef += (+r[5]||0); });
    document.getElementById('d_inp').innerText = tInp;
    document.getElementById('d_def').innerText = tDef;
    let rej = tInp > 0 ? (tDef/tInp*100).toFixed(2) : 0;
    document.getElementById('d_rej').innerText = rej + "%";
    document.getElementById('d_fpy').innerText = (100-rej).toFixed(2) + "%";
}

load();
</script>
</body>
</html>
