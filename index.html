<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Pro PQC Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- FontAwesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Charts -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
/* --- CORE VARIABLES --- */
:root {
    --primary: #4f46e5;   /* Indigo */
    --secondary: #3b82f6; /* Blue */
    --success: #10b981;   /* Green */
    --danger: #ef4444;    /* Red */
    --warning: #f59e0b;   /* Amber */
    --dark: #1e293b;
    --light: #f1f5f9;
    --card-bg: #ffffff;
}

body { font-family: 'Poppins', sans-serif; background: #f8fafc; margin: 0; padding: 15px; color: var(--dark); }

/* --- HEADER --- */
.header-box {
    background: var(--card-bg); padding: 15px 25px; border-radius: 15px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px;
    border-left: 6px solid var(--primary);
}
.app-logo { height: 45px; }
.app-title { font-size: 22px; font-weight: 700; color: var(--dark); margin-left: 15px; }

/* --- TABS --- */
.nav-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; background: #e2e8f0; padding: 6px; border-radius: 50px; width: fit-content; margin: 0 auto 25px auto; }
.tab-btn {
    padding: 10px 30px; border: none; border-radius: 40px; cursor: pointer;
    font-weight: 600; color: #64748b; background: transparent; transition: 0.3s; display: flex; align-items: center; gap: 8px;
}
.tab-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4); }

/* --- DASHBOARD STYLES --- */
.tab-content { display: none; animation: fadeIn 0.5s; }
.tab-content.active { display: block; }

/* Hero Cards (Top Row) */
.hero-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
.hero-card {
    padding: 20px; border-radius: 16px; color: white; position: relative; overflow: hidden;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
}
.bg-grad-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.bg-grad-green { background: linear-gradient(135deg, #10b981, #059669); }
.bg-grad-red { background: linear-gradient(135deg, #f43f5e, #e11d48); }
.bg-grad-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

.hc-info h4 { margin: 0; font-size: 14px; opacity: 0.9; font-weight: 500; }
.hc-info h2 { margin: 5px 0 0 0; font-size: 28px; font-weight: 700; }
.hc-icon { font-size: 40px; opacity: 0.3; }

/* Chart Section */
.chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
.chart-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.chart-title { font-size: 16px; font-weight: 700; color: var(--dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
#pie_chart, #bar_chart { width: 100%; height: 250px; }

/* Floor Cards Enhanced */
.floors-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
.floor-card-pro {
    background: white; border-radius: 16px; padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 5px solid #cbd5e1;
    transition: transform 0.3s;
}
.floor-card-pro:hover { transform: translateY(-5px); }
.fc-1 { border-color: var(--success); }
.fc-2 { border-color: var(--warning); }
.fc-b { border-color: var(--primary); }

.f-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.f-title { font-size: 16px; font-weight: 700; color: var(--dark); }
.f-icon { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }

/* Progress Bar Style */
.progress-container { background: #e2e8f0; height: 8px; border-radius: 5px; margin: 10px 0 20px 0; overflow: hidden; }
.progress-bar { height: 100%; border-radius: 5px; transition: width 1s; }

.mini-stats { display: flex; justify-content: space-between; text-align: center; }
.ms-box { flex: 1; border-right: 1px solid #f1f5f9; }
.ms-box:last-child { border-right: none; }
.ms-val { font-size: 15px; font-weight: 700; color: var(--dark); }
.ms-lbl { font-size: 10px; color: #64748b; font-weight: 600; }

/* --- OTHER ELEMENTS --- */
.card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
.form-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
.form-group { display: flex; flex-direction: column; flex: 1; min-width: 140px; }
label { font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #4b5563; }
input, select { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; font-family: 'Poppins'; }
button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: var(--primary); color: white; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
button:hover { transform: translateY(-2px); }

/* Table */
.table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
.table th { background: #f8fafc; padding: 12px; text-align: left; font-weight: 600; color: #475569; }
.table td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

/* Responsive */
@media (max-width: 768px) { .chart-row { grid-template-columns: 1fr; } }

/* Modal */
.overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(2px); z-index: 999; }
.modal-lg { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 900px; background: #fff; border-radius: 12px; z-index: 1000; box-shadow: 0 25px 50px rgba(0,0,0,0.3); overflow: hidden; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header-box">
    <div style="display:flex; align-items:center;">
        <img id="mainLogo" src="" class="app-logo"> 
        <div class="app-title">PQC Performance Dashboard</div>
    </div>
    <div style="text-align:right;">
        <div style="font-size:12px; color:#64748b; font-weight:600;">TODAY</div>
        <div style="font-size:14px; font-weight:bold; color:var(--primary);" id="curDate"></div>
    </div>
</div>

<!-- TABS -->
<div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</button>
    <button class="tab-btn" onclick="switchTab('entry')"><i class="fas fa-edit"></i> Data Entry</button>
    <button class="tab-btn" onclick="switchTab('report')"><i class="fas fa-folder-open"></i> Records</button>
</div>

<!-- TAB 1: DASHBOARD PRO -->
<div id="dashboard" class="tab-content active">
    
    <!-- Filter Bar -->
    <div style="background:white; padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; box-shadow:0 4px 10px rgba(0,0,0,0.03);">
        <div><h3 style="margin:0; color:var(--dark); font-size:16px;">Production Overview</h3></div>
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-calendar-alt" style="color:#64748b;"></i>
            <input type="month" id="dash_month" onchange="filterDashboard()" style="border:none; background:#f1f5f9; padding:8px 15px; border-radius:8px; font-weight:600; color:#475569;">
        </div>
    </div>

    <!-- 1. Hero Cards (Top Stats) -->
    <div class="hero-grid">
        <div class="hero-card bg-grad-blue">
            <div class="hc-info"><h4>Total Input</h4><h2 id="g_inp">0</h2></div>
            <div class="hc-icon"><i class="fas fa-boxes"></i></div>
        </div>
        <div class="hero-card bg-grad-green">
            <div class="hc-info"><h4>Overall FPY</h4><h2 id="g_fpy">--</h2></div>
            <div class="hc-icon"><i class="fas fa-check-circle"></i></div>
        </div>
        <div class="hero-card bg-grad-red">
            <div class="hc-info"><h4>Total Defects</h4><h2 id="g_def">0</h2></div>
            <div class="hc-icon"><i class="fas fa-exclamation-triangle"></i></div>
        </div>
        <div class="hero-card bg-grad-purple">
            <div class="hc-info"><h4>Rejection %</h4><h2 id="g_rej">--</h2></div>
            <div class="hc-icon"><i class="fas fa-chart-line"></i></div>
        </div>
    </div>

    <!-- 2. Graphs Row -->
    <div class="chart-row">
        <div class="chart-card">
            <div class="chart-title"><i class="fas fa-chart-pie" style="color:var(--primary);"></i> Overall Quality Ratio</div>
            <div id="pie_chart"></div>
        </div>
        <div class="chart-card">
            <!-- UPDATED TITLE -->
            <div class="chart-title"><i class="fas fa-chart-bar" style="color:var(--warning);"></i> Defect Breakdown (Percentage %)</div>
            <div id="bar_chart"></div>
        </div>
    </div>

    <!-- 3. Floor Wise Detailed Cards -->
    <h4 style="margin: 0 0 20px 0; color:#64748b; font-size:14px; text-transform:uppercase; letter-spacing:1px;">Floor Wise Performance</h4>
    
    <div class="floors-container">
        
        <!-- Floor 1 -->
        <div class="floor-card-pro fc-1">
            <div class="f-header">
                <div><div class="f-title">1st Floor</div><div style="font-size:11px; color:#64748b;">Line 1 - 8</div></div>
                <div class="f-icon bg-grad-green"><i class="fas fa-industry"></i></div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;"><span>FPY Target</span><span id="f1_fpy_txt" style="font-weight:bold; color:var(--success);">--</span></div>
            <div class="progress-container"><div id="f1_bar" class="progress-bar bg-grad-green" style="width:0%"></div></div>
            
            <div class="mini-stats">
                <div class="ms-box"><div class="ms-val" id="f1_rmd">--</div><div class="ms-lbl">RMD %</div></div>
                <div class="ms-box"><div class="ms-val" id="f1_proc">--</div><div class="ms-lbl">PROC %</div></div>
                <div class="ms-box"><div class="ms-val" id="f1_smt">--</div><div class="ms-lbl">SMT %</div></div>
            </div>
        </div>

        <!-- Floor 2 -->
        <div class="floor-card-pro fc-2">
            <div class="f-header">
                <div><div class="f-title">2nd Floor</div><div style="font-size:11px; color:#64748b;">Line 9 - 16</div></div>
                <div class="f-icon bg-grad-red" style="background:var(--warning);"><i class="fas fa-cogs"></i></div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;"><span>FPY Target</span><span id="f2_fpy_txt" style="font-weight:bold; color:var(--warning);">--</span></div>
            <div class="progress-container"><div id="f2_bar" class="progress-bar" style="width:0%; background:var(--warning);"></div></div>
            
            <div class="mini-stats">
                <div class="ms-box"><div class="ms-val" id="f2_rmd">--</div><div class="ms-lbl">RMD %</div></div>
                <div class="ms-box"><div class="ms-val" id="f2_proc">--</div><div class="ms-lbl">PROC %</div></div>
                <div class="ms-box"><div class="ms-val" id="f2_smt">--</div><div class="ms-lbl">SMT %</div></div>
            </div>
        </div>

        <!-- Basement -->
        <div class="floor-card-pro fc-b">
            <div class="f-header">
                <div><div class="f-title">Basement</div><div style="font-size:11px; color:#64748b;">Line 17 - 24</div></div>
                <div class="f-icon bg-grad-purple"><i class="fas fa-warehouse"></i></div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;"><span>FPY Target</span><span id="fb_fpy_txt" style="font-weight:bold; color:#8b5cf6;">--</span></div>
            <div class="progress-container"><div id="fb_bar" class="progress-bar bg-grad-purple" style="width:0%"></div></div>
            
            <div class="mini-stats">
                <div class="ms-box"><div class="ms-val" id="fb_rmd">--</div><div class="ms-lbl">RMD %</div></div>
                <div class="ms-box"><div class="ms-val" id="fb_proc">--</div><div class="ms-lbl">PROC %</div></div>
                <div class="ms-box"><div class="ms-val" id="fb_smt">--</div><div class="ms-lbl">SMT %</div></div>
            </div>
        </div>

    </div>
</div>

<!-- TAB 2: DATA ENTRY -->
<div id="entry" class="tab-content">
    <div class="card" id="entryForm">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>üìù New PQC Entry</h3>
            <button onclick="resetForm()" style="background:#94a3b8; font-size:12px; padding:6px 15px;">Clear</button>
        </div>
        <!-- Form Fields -->
        <div class="form-row">
            <div class="form-group"><label>Date</label><input type="date" id="f_date"></div>
            <div class="form-group"><label>Shift</label><select id="f_shift"><option>A</option><option>B</option><option>C</option></select></div>
            <div class="form-group"><label>Line No</label><input type="number" id="f_line" placeholder="1-24"></div>
            <div class="form-group"><label>Model</label><input id="f_model" placeholder="Enter Model"></div>
            <div class="form-group"><label>Input Qty</label><input id="f_input" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Defect Qty</label><input id="f_def" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Rej %</label><input id="f_rej" readonly></div>
            <div class="form-group"><label>FPY %</label><input id="f_fpy" readonly style="font-weight:700; color:var(--success);"></div>
        </div>
        <h4>Detailed Bifurcation</h4>
        <div class="form-row">
            <div class="form-group"><label>RMD Qty</label><input id="rmd" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>RMD %</label><input id="rmd_r" readonly></div>
            <div class="form-group"><label>Process Qty</label><input id="proc" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Process %</label><input id="proc_r" readonly></div>
            <div class="form-group"><label>SMT Qty</label><input id="smt" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>SMT %</label><input id="smt_r" readonly></div>
        </div>
        <h4>Top 3 Defects</h4>
        <datalist id="defect_list">
            <option value="Not On"><option value="Mic Fail"><option value="Speaker Fail"><option value="Channel Detection"><option value="Hard Glue"><option value="Body Sensor"><option value="RF Fail"><option value="Sensor Fail"><option value="Cavity Crack"><option value="Dut Mode"><option value="Dent, Scratch"><option value="Pogo Pin Issue"><option value="LED Issue"><option value="BT not connect"><option value="Buds Heating"><option value="Battery Drain"><option value="High Current"><option value="Inquiry Fail"><option value="Low Current"><option value="Low Sound"><option value="Electric Sound"><option value="Software PCBA"><option value="Polarity Reverse"><option value="Distortion"><option value="Key Issue"><option value="ANC Fail">
        </datalist>
        <div class="form-row">
            <div class="form-group"><label>Defect 1</label><input id="d1" list="defect_list" placeholder="Defect Name"><input id="q1" placeholder="Qty" type="number" style="margin-top:5px;"><input id="c1" placeholder="Cause" style="margin-top:5px;"><input id="a1" placeholder="Action" style="margin-top:5px;"></div>
            <div class="form-group"><label>Defect 2</label><input id="d2" list="defect_list" placeholder="Defect Name"><input id="q2" placeholder="Qty" type="number" style="margin-top:5px;"><input id="c2" placeholder="Cause" style="margin-top:5px;"><input id="a2" placeholder="Action" style="margin-top:5px;"></div>
            <div class="form-group"><label>Defect 3</label><input id="d3" list="defect_list" placeholder="Defect Name"><input id="q3" placeholder="Qty" type="number" style="margin-top:5px;"><input id="c3" placeholder="Cause" style="margin-top:5px;"><input id="a3" placeholder="Action" style="margin-top:5px;"></div>
        </div>
        <div class="form-row" style="margin-top:20px;">
            <div class="form-group"><label>Prepared By</label><input id="prep" placeholder="Enter Name"></div>
            <button onclick="saveData()" id="saveBtn" style="width:100%; margin-top:23px; height:45px;">SAVE RECORD</button>
        </div>
    </div>
</div>

<!-- TAB 3: RECORDS -->
<div id="report" class="tab-content">
    <div class="card">
        <h3>üìÇ Recorded Database</h3>
        <div style="background:#f1f5f9; padding:15px; border-radius:10px; margin-bottom:20px;">
            <div class="form-row">
                <div class="form-group" style="max-width: 140px;"><label>From</label><input type="date" id="date_from"></div>
                <div class="form-group" style="max-width: 140px;"><label>To</label><input type="date" id="date_to"></div>
                <div class="form-group" style="flex:2;"><label>Lines</label><div id="lineSelectBox" style="border:1px solid #cbd5e1; background:white; height:42px; overflow-y:auto; padding:5px; border-radius:8px;"></div></div>
                <div class="form-group" style="flex:1; justify-content: flex-end;"><button onclick="applyFilters()" style="margin-bottom:5px;">Search</button></div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table"><thead><tr id="thead"></tr></thead><tbody id="tbody"></tbody></table>
            <div id="noDataMsg" style="text-align:center; padding:30px; display:none; color:#64748b;">No records found.</div>
        </div>
    </div>
</div>

<!-- LANDSCAPE PREVIEW MODAL -->
<div class="overlay" id="overlay"></div>
<div class="modal-lg" id="previewModal">
  <div style="background:#f8fafc; padding:15px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
      <div style="display:flex; align-items:center; gap:15px;">
          <img id="modalLogo" src="" style="height:40px;">
          <div><div style="font-size:18px; font-weight:700;">PQC REPORT</div><div style="font-size:11px;">Detailed View</div></div>
      </div>
      <button onclick="closeModal()" style="background:#e2e8f0; color:#333;">Close</button>
  </div>
  <div style="padding:25px; max-height:85vh; overflow-y:auto;" id="previewContent"></div>
</div>

<script>
// --- CONFIGURATION ---
const API = "https://script.google.com/macros/s/AKfycbxR9xw1KJjLp0HUiHqyrSHgc4Ztt4HmWYNyfy8_tp50FubEaKbL36fJMQkjKNISQ_vXCA/exec";
const LOGO_URL = "https://i.postimg.cc/kRSbTd6w/logo.png"; 

document.getElementById('mainLogo').src = LOGO_URL;
document.getElementById('modalLogo').src = LOGO_URL;
document.getElementById('curDate').innerText = new Date().toLocaleDateString('en-IN');

// Load Charts
google.charts.load('current', {'packages':['corechart']});

let allData = []; 
let filteredData = []; 
let editingRowIndex = null; 

function init() {
    const box = document.getElementById('lineSelectBox');
    let html = '<div style="display:flex; gap:10px; flex-wrap:wrap;">';
    for(let i=1; i<=24; i++){ html += `<label style="font-size:11px; display:flex; align-items:center; gap:3px;"><input type="checkbox" value="${i}" class="line-chk"> L${i}</label>`; }
    html += '</div>'; box.innerHTML = html;
    document.getElementById('dash_month').value = new Date().toISOString().slice(0,7);
}
init();

function fixDate(dateValue) {
    if (!dateValue) return "";
    if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) return dateValue;
    let d = new Date(dateValue);
    if (isNaN(d.getTime())) return dateValue;
    return d.toLocaleDateString('en-CA');
}

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    const btns = document.querySelectorAll('.tab-btn');
    if(tabId === 'dashboard') btns[0].classList.add('active');
    if(tabId === 'entry') btns[1].classList.add('active');
    if(tabId === 'report') btns[2].classList.add('active');
}

function autoCalc(){
 let i = +f_input.value || 0; let d = +f_def.value || 0;
 if(i > 0){ f_rej.value = ((d/i)*100).toFixed(2); f_fpy.value = (100 - (d/i*100)).toFixed(2); } 
 else { f_rej.value = ""; f_fpy.value = ""; }
 rmd_r.value = i ? ((+rmd.value||0)/i*100).toFixed(2) : '';
 proc_r.value = i ? ((+proc.value||0)/i*100).toFixed(2) : '';
 smt_r.value = i ? ((+smt.value||0)/i*100).toFixed(2) : '';
}

async function saveData(){
  if(!f_line.value || !f_input.value) { alert("‚ö†Ô∏è Line & Input Required!"); return; }
  const row = [f_date.value, f_shift.value, f_line.value, f_model.value, f_input.value, f_def.value, f_rej.value, f_fpy.value, rmd.value, rmd_r.value, proc.value, proc_r.value, smt.value, smt_r.value, d1.value, q1.value, c1.value, a1.value, d2.value, q2.value, c2.value, a2.value, d3.value, q3.value, c3.value, a3.value, prep.value];
  
  const btn = document.getElementById("saveBtn"); btn.innerText = "‚è≥ SAVING..."; btn.disabled = true;
  try {
     const action = editingRowIndex !== null ? "edit" : "append";
     const bodyData = { action: action, row: row, rowIndex: editingRowIndex };
     const res = await fetch(API, { method: "POST", body: JSON.stringify(bodyData) });
     const result = await res.json();
     if(result.status === "saved" || result.status === "updated"){ showDetailedPreview(row, true); load(); resetForm(); } 
     else { alert("Failed"); }
  } catch(e) { alert("Error"); } finally { btn.innerText = "SAVE RECORD"; btn.disabled = false; }
}

function showDetailedPreview(r, isSubmit = false){
  const content = document.getElementById("previewContent");
  const d = fixDate(r[0]); 
  let fpy = parseFloat(r[7]) || 0;
  let statusColor = fpy >= 90 ? "#10b981" : "#ef4444";
  let statusText = fpy >= 90 ? "PASSED" : "ATTENTION";

  content.innerHTML = `
    <div style="display:grid; grid-template-columns:repeat(5,1fr); gap:10px; background:#eff6ff; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #dbeafe;">
        <div style="text-align:center;"><div style="font-size:10px; color:#64748b; font-weight:bold;">DATE</div><div style="font-weight:700;">${d}</div></div>
        <div style="text-align:center;"><div style="font-size:10px; color:#64748b; font-weight:bold;">SHIFT</div><div style="font-weight:700;">${r[1]}</div></div>
        <div style="text-align:center;"><div style="font-size:10px; color:#64748b; font-weight:bold;">LINE</div><div style="font-weight:700;">L-${r[2]}</div></div>
        <div style="text-align:center;"><div style="font-size:10px; color:#64748b; font-weight:bold;">MODEL</div><div style="font-weight:700; color:var(--primary);">${r[3]}</div></div>
        <div style="text-align:center;"><div style="font-size:10px; color:#64748b; font-weight:bold;">USER</div><div style="font-weight:700;">${r[26]}</div></div>
    </div>
    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px;">
        <div style="background:#3b82f6; color:white; padding:15px; border-radius:8px; text-align:center;"><div style="font-size:20px; font-weight:bold;">${r[4]}</div><div style="font-size:10px;">INPUT</div></div>
        <div style="background:#ef4444; color:white; padding:15px; border-radius:8px; text-align:center;"><div style="font-size:20px; font-weight:bold;">${r[5]}</div><div style="font-size:10px;">DEFECTS</div></div>
        <div style="background:#10b981; color:white; padding:15px; border-radius:8px; text-align:center;"><div style="font-size:20px; font-weight:bold;">${r[7]}%</div><div style="font-size:10px;">FPY</div></div>
        <div style="background:${statusColor}; color:white; padding:15px; border-radius:8px; text-align:center;"><div style="font-size:16px; font-weight:bold; margin-top:3px;">${statusText}</div><div style="font-size:10px;">STATUS</div></div>
    </div>
    <div style="display:grid; grid-template-columns:3fr 2fr; gap:20px;">
        <div>
            <h4 style="margin-top:0;">Process Details</h4>
            <table class="table" style="border:1px solid #e2e8f0;">
                <thead><tr><th>Stage</th><th>Rejected</th><th>%</th></tr></thead>
                <tbody>
                    <tr><td>RMD</td><td>${r[8]||0}</td><td>${r[9]||0}%</td></tr>
                    <tr><td>Process</td><td>${r[10]||0}</td><td>${r[11]||0}%</td></tr>
                    <tr><td>SMT</td><td>${r[12]||0}</td><td>${r[13]||0}%</td></tr>
                </tbody>
            </table>
        </div>
        <div>
            <h4 style="margin-top:0;">Top Defects</h4>
            ${r[14] ? `<div style="background:white; border:1px solid #cbd5e1; padding:8px; border-radius:6px; margin-bottom:5px; border-left:3px solid #f59e0b;"><div style="font-weight:bold;">1. ${r[14]} (${r[15]})</div><div style="font-size:11px; color:#666;">C: ${r[16]||'-'} | A: ${r[17]||'-'}</div></div>` : '<div style="color:#999;">No defects</div>'}
            ${r[18] ? `<div style="background:white; border:1px solid #cbd5e1; padding:8px; border-radius:6px; margin-bottom:5px; border-left:3px solid #f59e0b;"><div style="font-weight:bold;">2. ${r[18]} (${r[19]})</div><div style="font-size:11px; color:#666;">C: ${r[20]||'-'} | A: ${r[21]||'-'}</div></div>` : ''}
            ${r[22] ? `<div style="background:white; border:1px solid #cbd5e1; padding:8px; border-radius:6px; margin-bottom:5px; border-left:3px solid #f59e0b;"><div style="font-weight:bold;">3. ${r[22]} (${r[23]})</div><div style="font-size:11px; color:#666;">C: ${r[24]||'-'} | A: ${r[25]||'-'}</div></div>` : ''}
        </div>
    </div>`;
  document.getElementById("overlay").style.display = 'block';
  document.getElementById("previewModal").style.display = 'block';
}

function closeModal(){ document.getElementById("overlay").style.display='none'; document.getElementById("previewModal").style.display='none'; }

function editRow(index, r){
  editingRowIndex = index;
  f_date.value=fixDate(r[0]); f_shift.value=r[1]; f_line.value=r[2]; f_model.value=r[3]; f_input.value=r[4]; f_def.value=r[5]; f_rej.value=r[6]; f_fpy.value=r[7];
  rmd.value=r[8]; rmd_r.value=r[9]; proc.value=r[10]; proc_r.value=r[11]; smt.value=r[12]; smt_r.value=r[13];
  d1.value=r[14]; q1.value=r[15]; c1.value=r[16]; a1.value=r[17]; d2.value=r[18]; q2.value=r[19]; c2.value=r[20]; a2.value=r[21]; d3.value=r[22]; q3.value=r[23]; c3.value=r[24]; a3.value=r[25]; prep.value=r[26];
  switchTab('entry'); document.getElementById("saveBtn").innerText = "UPDATE RECORD"; document.getElementById("saveBtn").style.background = "#f59e0b";
}

function resetForm(){ document.querySelectorAll('input').forEach(i => i.value = ''); document.getElementById('f_shift').value = 'A'; editingRowIndex = null; document.getElementById("saveBtn").innerText = "SAVE RECORD"; document.getElementById("saveBtn").style.background = "var(--primary)"; }

async function load(){ try { const res = await fetch(API); const j = await res.json(); allData = j.rows; applyFilters(); filterDashboard(); } catch(e) { console.error(e); } }

function applyFilters() {
    if(!allData || allData.length === 0) return;
    const dFrom = document.getElementById("date_from").value; const dTo = document.getElementById("date_to").value;
    const checkboxes = document.querySelectorAll('.line-chk:checked'); const selectedLines = Array.from(checkboxes).map(cb => cb.value);
    const t = document.getElementById('tbody'); const h = document.getElementById('thead'); t.innerHTML = ""; h.innerHTML = ""; document.getElementById("noDataMsg").style.display = 'none';
    allData[0].forEach(x => h.innerHTML += `<th>${x}</th>`); h.innerHTML += `<th>Floor</th><th>Action</th>`;
    filteredData = []; 
    allData.slice(1).forEach((r, index) => {
        let rDate = fixDate(r[0]); let rLine = r[2].toString(); let match = true;
        if(dFrom && rDate < dFrom) match = false; if(dTo && rDate > dTo) match = false; if(selectedLines.length > 0 && !selectedLines.includes(rLine)) match = false;
        if(match) { filteredData.push(r); let tr = document.createElement("tr"); r.forEach((c, i) => { if(i===0) tr.innerHTML += `<td>${fixDate(c)}</td>`; else tr.innerHTML += `<td>${c||""}</td>`; }); tr.innerHTML += `<td><b>${getFloorName(r[2])}</b></td>`; tr.innerHTML += `<td><button class="btn-view" onclick='showDetailedPreview(${JSON.stringify(r)})' style="padding:5px 8px;">üëÅÔ∏è</button> <button class="btn-edit" onclick='editRow(${index+1}, ${JSON.stringify(r)})' style="padding:5px 8px;">‚úé</button> <button class="btn-danger" onclick="deleteRow(${index+1})" style="padding:5px 8px;">üóë</button></td>`; t.appendChild(tr); }
    });
    if(filteredData.length === 0) document.getElementById("noDataMsg").style.display = 'block';
}

function filterDashboard() {
    const monthInput = document.getElementById('dash_month').value; 
    if(!allData || allData.length < 2) return;
    const dashboardRows = allData.slice(1).filter(r => fixDate(r[0]).startsWith(monthInput));
    updateDashboard(dashboardRows);
}

function updateDashboard(rows){
  let stats = { g:{i:0,d:0,r:0,p:0,s:0}, f1:{i:0,d:0,r:0,p:0,s:0}, f2:{i:0,d:0,r:0,p:0,s:0}, fb:{i:0,d:0,r:0,p:0,s:0} };
  rows.forEach(r => {
    let line = parseInt(r[2]) || 0; let inp = +r[4]||0; let def = +r[5]||0; let rmd = +r[8]||0; let proc = +r[10]||0; let smt = +r[12]||0;
    const add = (k) => { stats[k].i += inp; stats[k].d += def; stats[k].r += rmd; stats[k].p += proc; stats[k].s += smt; };
    add('g'); if(line>=1 && line<=8) add('f1'); else if(line>=9 && line<=16) add('f2'); else if(line>=17 && line<=24) add('fb');
  });
  
  // Render Stats
  const calc = (n, t) => t>0 ? (n/t*100).toFixed(2) : "0.00";
  const el = (id, val) => { if(document.getElementById(id)) document.getElementById(id).innerText = val; };
  
  el("g_inp", stats.g.i); el("g_fpy", calc(stats.g.i-stats.g.d, stats.g.i) + "%"); el("g_def", stats.g.d); el("g_rej", calc(stats.g.d, stats.g.i) + "%");
  
  const renderFloor = (p, d) => {
      let fpy = calc(d.i-d.d, d.i);
      el(p+"_fpy", fpy + "%");
      el(p+"_fpy_txt", fpy + "%");
      el(p+"_rmd", calc(d.r, d.i) + "%");
      el(p+"_proc", calc(d.p, d.i) + "%");
      el(p+"_smt", calc(d.s, d.i) + "%");
      if(document.getElementById(p+"_bar")) document.getElementById(p+"_bar").style.width = fpy + "%";
  };
  
  renderFloor('f1', stats.f1); renderFloor('f2', stats.f2); renderFloor('fb', stats.fb);

  if(google && google.visualization && stats.g.i > 0) {
      // Pie
      var pieData = google.visualization.arrayToDataTable([['Type', 'Qty'], ['Good', stats.g.i-stats.g.d], ['Defects', stats.g.d]]);
      var pieChart = new google.visualization.PieChart(document.getElementById('pie_chart'));
      pieChart.draw(pieData, {colors:['#10b981','#ef4444'], pieHole: 0.4, chartArea:{width:'90%',height:'80%'}, legend:{position:'bottom'}});

      // Bar with Percentage
      let totalBreakdown = stats.g.r + stats.g.p + stats.g.s;
      let rmdPer = totalBreakdown > 0 ? (stats.g.r / totalBreakdown * 100) : 0;
      let procPer = totalBreakdown > 0 ? (stats.g.p / totalBreakdown * 100) : 0;
      let smtPer = totalBreakdown > 0 ? (stats.g.s / totalBreakdown * 100) : 0;

      var barData = google.visualization.arrayToDataTable([
        ['Type', 'Percentage', { role: 'style' }, { role: 'annotation' }], 
        ['RMD', rmdPer, '#3b82f6', rmdPer.toFixed(1) + '%'], 
        ['Process', procPer, '#8b5cf6', procPer.toFixed(1) + '%'], 
        ['SMT', smtPer, '#f59e0b', smtPer.toFixed(1) + '%']
      ]);
      
      var barChart = new google.visualization.ColumnChart(document.getElementById('bar_chart'));
      barChart.draw(barData, {
        legend: 'none', 
        chartArea: {width:'85%',height:'75%'}, 
        vAxis: {minValue: 0, format: '#\'%\''}
      });
  }
}

function getFloorName(l){ l = parseInt(l); if(l>=1 && l<=8) return "1st Floor"; if(l>=9 && l<=16) return "2nd Floor"; if(l>=17 && l<=24) return "Basement"; return "Other"; }
async function deleteRow(i){ if(confirm("Delete?")){ await fetch(API, {method:'POST', body:JSON.stringify({action:'delete', rowIndex:i})}); load(); } }
window.onresize = function(){ filterDashboard(); }; 
load();
</script>
</body>
</html>
