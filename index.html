<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Master System v5.1 (Bug Fixed)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root { --primary: #002244; --accent: #007bff; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; font-size: 20px; }
        .app-header { background: var(--primary); color: white; padding: 12px 30px; display: flex; align-items: center; justify-content: space-between; }
        .logo { height: 45px; }
        .nav-pills .nav-link { color: #cbd5e0; font-weight: 500; font-size: 18px; }
        .nav-pills .nav-link.active { background-color: var(--accent); color: white; }

        /* KPI Style matching your image */
        .preview-card { border-radius: 12px; border: none; color: white; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card-total { background-color: #003366; }
        .card-passed { background-color: #50c878; }
        .card-rejected { background-color: #ff4d4d; }
        .card-rate { background-color: #33ccff; color: #000; }
        
        .kpi-title { font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .kpi-main-val { font-size: 36px; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        .kpi-sub-text { font-size: 15px; opacity: 0.9; }

        .table-custom thead { background: #f8f9fa; border-top: 2px solid #dee2e6; }
        .status-badge { padding: 4px 12px; border-radius: 15px; font-size: 14px; font-weight: bold; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <div class="ms-3 fw-bold">Loading Data...</div>
</div>

<div class="app-header">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <h5 class="m-0 fw-bold">PDI MASTER SYSTEM</h5>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form', this)">Data Entry</button>
    </div>
</div>

<div class="container-fluid mt-4">
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editRowIndex">
            <div class="card p-3 mb-3 border-0 shadow-sm">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label class="fw-bold small">Entry Date</label>
                        <input type="date" id="entryDate" class="form-control" required>
                    </div>
                    <div class="col-md-9 text-end">
                        <button type="button" class="btn btn-primary fw-bold" onclick="addLotRow()">+ ADD ROW</button>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0">
                        <thead class="table-light text-center small">
                            <tr>
                                <th width="100">Line</th><th width="200">Model</th><th width="180">Colour</th>
                                <th width="140">Lot ID</th><th width="100">Qty</th><th width="120">Result</th>
                                <th>Defect / Remarks</th><th width="50"></th>
                            </tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>
            <div class="text-end mb-5">
                <button type="submit" id="saveBtn" class="btn btn-success px-5 fw-bold btn-lg">SAVE TO SHEET</button>
            </div>
        </form>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <span class="fw-bold text-primary">Daily Records Tracking</span>
                <div class="d-flex gap-2">
                    <input type="date" id="recentFilter" class="form-control w-auto" onchange="renderRecentTable()">
                    <button class="btn btn-primary fw-bold" onclick="showDaySummary()">View Daily Preview</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center align-middle">
                    <thead class="table-dark small">
                        <tr><th>Date</th><th>Line</th><th>Model</th><th>Lot ID</th><th>Qty</th><th>Result</th><th>Action</th></tr>
                    </thead>
                    <tbody id="crudTable" class="small"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0" style="border-radius: 15px;">
            <div class="modal-header border-0 pb-0">
                <div class="d-flex align-items-center gap-3">
                    <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height: 40px;">
                    <div>
                        <h4 class="modal-title fw-bold m-0">Daily Production Report</h4>
                        <small class="text-muted" id="previewDateText"></small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 pt-3">
                <div id="summaryBody"></div>
            </div>
            <div class="text-center pb-3 text-muted small">Generated by PDI Master System v5.1</div>
        </div>
    </div>
</div>

<script>
const API_URL = "YOUR_SCRIPT_URL_HERE";

// MODELS/COLOURS yaha apne list ke mutabiq rakhein
const MODELS = ["Ace", "161 Pro-Buds", "131 Gen 2", "Ad Primo", "Ad 311 Pro"];
const COLOURS = ["Black", "Blue", "White"];

window.onload = function() {
    let today = new Date().toISOString().split('T')[0];
    document.getElementById('entryDate').value = today;
    document.getElementById('recentFilter').value = today;
    addLotRow();
    loadAllData();
};

// --- FIX: DATE HANDLING FUNCTION ---
function formatDateFixed(dateInput) {
    if (!dateInput) return "";
    let d = new Date(dateInput);
    // Offset fix: JS dates often shift by 1 day based on UTC. 
    // We force it to use local date parts.
    let month = '' + (d.getMonth() + 1);
    let day = '' + d.getDate();
    let year = d.getFullYear();
    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;
    return [year, month, day].join('-');
}

async function loadAllData() {
    document.getElementById('loader').style.display='flex';
    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        sheetData = json.data;
        if(sheetData[0] && sheetData[0][0] === "Date") sheetData.shift();
        renderRecentTable();
    } catch(e) { console.error(e); }
    document.getElementById('loader').style.display='none';
}

function renderRecentTable() {
    const tb = document.getElementById('crudTable');
    const fDate = document.getElementById('recentFilter').value; // YYYY-MM-DD
    tb.innerHTML = "";
    
    // Filter logic based on fixed date format
    let filtered = sheetData.filter(r => formatDateFixed(r[0]) === fDate);

    filtered.reverse().forEach(r => {
        let idx = sheetData.indexOf(r);
        tb.innerHTML += `<tr>
            <td>${new Date(r[0]).toLocaleDateString()}</td><td>L${r[1]}</td><td>${r[3]}</td>
            <td><b>${r[5]}</b></td><td>${r[6]}</td>
            <td><span class="status-badge ${r[8]==='Pass'?'bg-success text-white':'bg-danger text-white'} opacity-75">${r[8]}</span></td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editRec(${idx})">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteRec(${idx})">Del</button>
            </td>
        </tr>`;
    });
}

function showDaySummary() {
    const fDate = document.getElementById('recentFilter').value;
    const dateObj = new Date(fDate);
    document.getElementById('previewDateText').innerText = "Report Date: " + dateObj.toDateString();
    
    // Filter data specifically for the selected date
    let dayData = sheetData.filter(r => formatDateFixed(r[0]) === fDate);
    
    if(!dayData.length) { alert("No data found for the selected date!"); return; }

    let pLots = 0, fLots = 0, tQty = 0, pQty = 0, fQty = 0;
    let floors = {
        "Floor 1": {tQ:0, pQ:0, tL:0, pL:0}, 
        "Floor 2": {tQ:0, pQ:0, tL:0, pL:0}, 
        "Basement": {tQ:0, pQ:0, tL:0, pL:0}
    };
    let rejects = [];

    dayData.forEach(r => {
        let q = parseInt(r[6]||0);
        let fl = r[2] || "Floor 1";
        tQty += q;
        
        if(r[8] === 'Pass') {
            pQty += q;
            pLots++;
            if(floors[fl]) { floors[fl].pQ += q; floors[fl].pL++; floors[fl].tL++; floors[fl].tQ += q; }
        } else {
            fQty += q;
            fLots++;
            rejects.push(r);
            if(floors[fl]) { floors[fl].tL++; floors[fl].tQ += q; }
        }
    });

    // --- FIX: FORMULA (Pass Lot + Reject Lot = Total Lot) ---
    let totalLotsDisplay = pLots + fLots;
    let overallRate = tQty > 0 ? ((pQty / tQty) * 100).toFixed(2) : 0;

    let html = `
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="preview-card card-total">
                    <div class="kpi-title">Total Lots</div>
                    <div class="kpi-main-val">${totalLotsDisplay}</div>
                    <div class="kpi-sub-text">Total Units: ${tQty}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="preview-card card-passed">
                    <div class="kpi-title">Passed Lots</div>
                    <div class="kpi-main-val">${pLots}</div>
                    <div class="kpi-sub-text">Passed Units: ${pQty}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="preview-card card-rejected">
                    <div class="kpi-title">Rejected Lots</div>
                    <div class="kpi-main-val">${fLots}</div>
                    <div class="kpi-sub-text">Rejected Units: ${fQty}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="preview-card card-rate">
                    <div class="kpi-title">Pass Rate %</div>
                    <div class="kpi-main-val">${overallRate}%</div>
                    <div class="kpi-sub-text">(Pass Qty / Total Qty)</div>
                </div>
            </div>
        </div>

        <h6 class="fw-bold text-primary mb-3">Floor Performance Breakdown</h6>
        <table class="table table-sm text-center align-middle mb-4 border">
            <thead class="bg-light small">
                <tr><th>FLOOR NAME</th><th>TOTAL LOTS</th><th>PASS LOTS</th><th>TOTAL QTY</th><th>PASS QTY</th><th>PASS RATE %</th></tr>
            </thead>
            <tbody class="small">
                ${Object.keys(floors).map(f => {
                    let fRate = floors[f].tQ > 0 ? ((floors[f].pQ / floors[f].tQ)*100).toFixed(2) : 0;
                    return `<tr>
                        <td class="fw-bold">${f}</td><td>${floors[f].tL}</td>
                        <td class="text-success fw-bold">${floors[f].pL}</td>
                        <td>${floors[f].tQ}</td><td>${floors[f].pQ}</td>
                        <td class="text-primary fw-bold">${fRate}%</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>

        <h6 class="fw-bold text-danger mb-2">Defective Lot Details</h6>
        <table class="table table-sm table-hover border text-center align-middle">
            <thead class="table-danger small">
                <tr><th>Line</th><th>Model Name</th><th>Lot ID</th><th>Qty</th><th>Status</th><th>Defect/Remarks</th></tr>
            </thead>
            <tbody class="small">
                ${rejects.map(r => `<tr>
                    <td>L${r[1]}</td><td>${r[3]}</td><td><b>${r[5]}</b></td><td>${r[6]}</td>
                    <td><span class="badge bg-danger">Fresh</span></td><td>${r[9]||"-"}</td>
                </tr>`).join('')}
                ${rejects.length === 0 ? '<tr><td colspan="6" class="p-2 text-muted">No rejections found.</td></tr>' : ''}
            </tbody>
        </table>
    `;
    document.getElementById('summaryBody').innerHTML = html;
    new bootstrap.Modal(document.getElementById('summaryModal')).show();
}

function addLotRow(data = null) {
    const tr = document.createElement('tr');
    tr.className = 'input-row';
    let lOpts = ''; for(let i=1; i<=21; i++) lOpts += `<option value="${i}">L${i}</option>`;
    tr.innerHTML = `
        <td><select class="form-select form-select-sm i-line" required><option value="">-</option>${lOpts}</select></td>
        <td><select class="form-select form-select-sm i-model" required><option value="">-</option>${MODELS.map(m=>`<option value="${m}">${m}</option>`).join('')}</select></td>
        <td><select class="form-select form-select-sm i-color" required><option value="">-</option>${COLOURS.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></td>
        <td><input type="text" class="form-control form-control-sm i-id" required style="text-transform:uppercase;"></td>
        <td><input type="number" class="form-control form-control-sm i-qty" required></td>
        <td><select class="form-select form-select-sm i-res fw-bold text-center"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></td>
        <td><input type="text" class="form-control form-control-sm i-rem" placeholder="Remarks"></td>
        <td><button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="this.closest('tr').remove()">âœ–</button></td>
    `;
    document.getElementById('lotContainer').appendChild(tr);
}

function switchTab(tab, btn) {
    document.getElementById('tab-form').style.display = 'block';
}

document.getElementById('pdiForm').onsubmit = async (e) => {
    e.preventDefault();
    document.getElementById('loader').style.display='flex';
    const date = document.getElementById('entryDate').value;
    const editIdx = document.getElementById('editRowIndex').value;
    let rows = [];
    document.querySelectorAll('.input-row').forEach(tr => {
        let l = tr.querySelector('.i-line').value;
        rows.push([date, l, (l<=8?"Floor 1":(l<=16?"Floor 2":"Basement")), tr.querySelector('.i-model').value, tr.querySelector('.i-color').value, tr.querySelector('.i-id').value.toUpperCase(), tr.querySelector('.i-qty').value, "Fresh", tr.querySelector('.i-res').value, tr.querySelector('.i-rem').value||""]);
    });
    
    try {
        let p = editIdx ? {action:'edit', rowIndex:editIdx, data:rows[0]} : {action:'save', data:rows};
        await fetch(API_URL, {method:'POST', body:JSON.stringify(p)});
        document.getElementById('pdiForm').reset();
        document.getElementById('lotContainer').innerHTML = "";
        addLotRow();
        loadAllData();
    } catch(err) { alert("Error saving data!"); }
};
</script>
</body>
</html>
