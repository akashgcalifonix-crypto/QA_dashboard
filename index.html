function autoCalc(){
let i=+f_input.value||0,d=+f_def.value||0;
if(i>0){
f_rej.value=((d/i)100).toFixed(2);
f_fpy.value=(100-(d/i100)).toFixed(2);
}
rmd_r.value=i?((+rmd.value||0)/i100).toFixed(2):'';
proc_r.value=i?((+proc.value||0)/i100).toFixed(2):'';
smt_r.value=i?((+smt.value||0)/i*100).toFixed(2):'';
}
/* ✅ ONLY ONE SAVE FUNCTION */
async function saveData(){
const row=[
f_date.value,f_shift.value,f_line.value,f_model.value,
f_input.value,f_def.value,f_rej.value,f_fpy.value,
rmd.value,rmd_r.value,
proc.value,proc_r.value,
smt.value,smt_r.value,
d1.value,q1.value,c1.value,a1.value,
d2.value,q2.value,c2.value,a2.value,
d3.value,q3.value,c3.value,a3.value,
prep.value
];
try{
const res = await fetch(API,{
method:"POST",
headers:{ "Content-Type":"application/json" },
body: JSON.stringify({
action:"append",
row: row
})
});
const result = await res.json();
if(result.status==="saved"){
alert("✅ Data Saved Successfully");
showPreview(row);
load();
}else{
alert("❌ Save failed");
console.log(result);
}
}catch(err){
alert("❌ Error while saving");
console.error(err);
}
}
function showPreview(r){
preview.innerHTML=`
 <h3>Saved Preview</h3>
 <p><b>Date:</b> ${r[0]} | <b>Line:</b> ${r[2]}</p>
 <p class="red">Rejection % : ${r[6]}</p>
 <p class="green">FPY % : ${r[7]}</p>
 <button onclick="preview.style.display='none'">Close</button>
 `;
 preview.style.display="block";
}
async function load(){
const res = await fetch(API);
const j = await res.json();
const rows=j.rows;
thead.innerHTML="";
tbody.innerHTML="";
rows[0].forEach(h=>thead.innerHTML+=<th>${h}</th>);
rows.slice(1).forEach((r,i)=>{
let tr=document.createElement("tr");
r.forEach(c=>tr.innerHTML+=<td>${c||""}</td>);
tbody.appendChild(tr);
});
updateKPIs(rows.slice(1));
}
function updateKPIs(rows){
let inp=0,def=0,r=0,p=0,s=0;
rows.forEach(x=>{
inp+=+x[4]||0;
def+=+x[5]||0;
r+=+x[8]||0;
p+=+x[10]||0;
s+=+x[12]||0;
});
if(inp>0){
kpi_rej.innerText=(def/inp100).toFixed(2)+"%";
kpi_fpy.innerText=(100-(def/inp100)).toFixed(2)+"%";
kpi_rmd.innerText=(r/inp100).toFixed(2)+"%";
kpi_proc.innerText=(p/inp100).toFixed(2)+"%";
kpi_smt.innerText=(s/inp*100).toFixed(2)+"%";
}
}
load();
</script>
