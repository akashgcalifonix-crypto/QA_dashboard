<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Quality Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: sans-serif; }
        .card { border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; border: none; }
        .card-header { background: #fff; font-weight: bold; color: #333; border-bottom: 2px solid #ffc107; }
        .form-label { font-weight: 600; font-size: 0.9rem; }
        .btn-warning { color: #fff; font-weight: bold; }
        th { font-size: 0.85rem; background-color: #343a40 !important; color: white; vertical-align: middle; }
        td { font-size: 0.85rem; vertical-align: middle; }
    </style>
</head>
<body>

<div class="container-fluid">
    <!-- Form Section -->
    <div class="card">
        <div class="card-header">QA Entry Form</div>
        <div class="card-body">
            <form id="qaForm">
                <input type="hidden" name="rowId" id="rowId"> <!-- Hidden ID for Editing -->
                
                <div class="row g-3">
                    <!-- Date -->
                    <div class="col-md-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="Date" id="dateInput" class="form-control" required>
                    </div>

                    <!-- Top 3 Defects -->
                    <div class="col-md-9">
                        <label class="form-label">Top-3 Defect</label>
                        <input type="text" name="Top3Defect" id="top3Input" class="form-control" placeholder="e.g. SPK Fail, Mic NG...">
                    </div>

                    <!-- Metrics -->
                    <div class="col-md-2">
                        <label class="form-label">Process Qty</label>
                        <input type="number" name="ProcessQty" id="procQty" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Process %</label>
                        <input type="text" name="ProcessPerc" id="procPerc" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">SMT Qty</label>
                        <input type="number" name="SMTQty" id="smtQty" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">SMT %</label>
                        <input type="text" name="SMTPerc" id="smtPerc" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">RMD %</label>
                        <input type="text" name="RMD" id="rmdInput" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Prepared By</label>
                        <input type="text" name="PreparedBy" id="prepBy" class="form-control" placeholder="Name">
                    </div>
                </div>

                <!-- Defect 1 Details (Example from screenshot) -->
                <h6 class="mt-3 text-primary border-bottom pb-1">Defect 1 Details</h6>
                <div class="row g-3">
                    <div class="col-md-3"><input type="text" name="Defect1" id="def1" class="form-control" placeholder="Defect Name"></div>
                    <div class="col-md-2"><input type="number" name="Qty1" id="qty1" class="form-control" placeholder="Qty"></div>
                    <div class="col-md-3"><input type="text" name="Cause1" id="cause1" class="form-control" placeholder="Root Cause"></div>
                    <div class="col-md-4"><input type="text" name="Action1" id="act1" class="form-control" placeholder="Action Taken"></div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-warning w-100" id="submitBtn">SAVE DATA</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Records Table -->
    <div class="card">
        <div class="card-header"><i class="bi bi-folder"></i> Records</div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <input type="date" id="filterDate" class="form-control">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="loadData()">Refresh</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover text-center">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Top-3 Defect</th>
                            <th>Proc Qty</th>
                            <th>SMT Qty</th>
                            <th>RMD %</th>
                            <th>Defect 1</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="7">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    // Yahan apna Naya Web App URL dalein
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxkY9T8l7JsqBFp7nNk3gYZdVjcBikgkZoHUP4IYEPNSKXbOjUUxPeypBiMqrqR6l-BiQ/exec'; 

    let globalData = []; // Store data for editing

    // --- 2. LOAD DATA ---
    function loadData() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
        
        fetch(SCRIPT_URL)
        .then(response => response.json())
        .then(json => {
            if(json.result === 'success') {
                globalData = json.data; // Save for editing
                renderTable(globalData);
            } else {
                tbody.innerHTML = '<tr><td colspan="7">Error loading data</td></tr>';
            }
        })
        .catch(err => {
            console.error(err);
            tbody.innerHTML = '<tr><td colspan="7">Connection Failed (Check CORS/URL)</td></tr>';
        });
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        // Filter Logic
        const filterVal = document.getElementById('filterDate').value;
        
        // Assuming Column mapping based on screenshot:
        // 0: ID, 1: Date, 2: Top3Defect, 3: ProcQty, 4: Proc%, 5: SMTQty, 6: SMT%, 7: RMD, 8: PrepBy, 9: Def1, 10: Qty1...
        
        data.forEach((row, index) => {
            let rowDate = formatDate(row[1]); // Format date for display
            
            if(filterVal && rowDate !== filterVal) return;

            let tr = `
                <tr>
                    <td>${rowDate}</td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                    <td>${row[5]}</td>
                    <td>${row[7]}</td>
                    <td>${row[9]}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editRow(${index})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRow('${row[0]}')">Del</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += tr;
        });
        
        if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="7">No Records Found</td></tr>';
    }

    // --- 3. EDIT FUNCTION (FIXED) ---
    function editRow(index) {
        // Data get karo global array se
        let r = globalData[index];
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // Change Button Text
        document.getElementById('submitBtn').innerText = "UPDATE DATA";
        document.getElementById('submitBtn').classList.remove('btn-warning');
        document.getElementById('submitBtn').classList.add('btn-success');

        // --- FORM FILLING ---
        document.getElementById('rowId').value = r[0]; // Hidden ID
        
        // Date Fix: Date object ko YYYY-MM-DD string mein convert karna padta hai
        document.getElementById('dateInput').value = formatDate(r[1]); 

        // Baki Fields populate karo
        document.getElementById('top3Input').value = r[2];
        document.getElementById('procQty').value = r[3];
        document.getElementById('procPerc').value = r[4];
        document.getElementById('smtQty').value = r[5];
        document.getElementById('smtPerc').value = r[6];
        document.getElementById('rmdInput').value = r[7];
        document.getElementById('prepBy').value = r[8];
        
        // Defect 1 Details
        document.getElementById('def1').value = r[9] || '';
        document.getElementById('qty1').value = r[10] || '';
        document.getElementById('cause1').value = r[11] || '';
        document.getElementById('act1').value = r[12] || '';
    }

    // --- 4. DATE FORMATTER HELPER ---
    function formatDate(isoDate) {
        if (!isoDate) return '';
        let d = new Date(isoDate);
        if (isNaN(d.getTime())) return isoDate; // Agar already string hai to wahi return karo
        return d.toISOString().split('T')[0]; // YYYY-MM-DD
    }

    // --- 5. SAVE / UPDATE DATA ---
    const form = document.getElementById('qaForm');
    form.addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;

        const fd = new FormData(form);
        
        // Check mode: Update or New
        const id = document.getElementById('rowId').value;
        if(id) {
            fd.append('action', 'edit');
            fd.append('editRowId', id);
        } else {
            fd.append('action', 'save');
        }

        fetch(SCRIPT_URL, { method: 'POST', body: fd })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            form.reset();
            document.getElementById('rowId').value = '';
            document.getElementById('submitBtn').innerText = "SAVE DATA";
            document.getElementById('submitBtn').classList.add('btn-warning');
            document.getElementById('submitBtn').classList.remove('btn-success');
            btn.disabled = false;
            loadData(); // Refresh table
        })
        .catch(err => {
            alert("Error saving data. Check Console.");
            console.error(err);
            btn.innerText = originalText;
            btn.disabled = false;
        });
    });

    // --- 6. DELETE FUNCTION ---
    function deleteRow(id) {
        if(confirm("Are you sure you want to delete this?")) {
            const fd = new FormData();
            fd.append('action', 'delete');
            fd.append('rowIndex', id);
            
            fetch(SCRIPT_URL, { method: 'POST', body: fd })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                loadData();
            });
        }
    }

    // Load data on start
    loadData();

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
