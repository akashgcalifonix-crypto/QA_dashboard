<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Quality Dashboard ‚Äì Floor Wise</title>

<!-- Google Charts & Utils -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
body{font-family:Arial, sans-serif; background:#f4f7fb; margin:20px; color:#333;}
.card{background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); margin-bottom:20px;}
h2,h3,h4{margin-top:0; color:#444;}
h4{border-bottom:2px solid #eee; padding-bottom:5px; margin-bottom:15px;}

/* Form Styles */
.form-row{display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;}
.form-group{display:flex; flex-direction:column; min-width:140px; flex:1;}
label{font-size:12px; font-weight:bold; margin-bottom:5px; color:#666;}
input,select{padding:8px; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box;}
input:focus{border-color:#0b66d2; outline:none;}

/* Buttons */
button{background:#0b66d2; color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.3s;}
button:hover{background:#084d9e;}
button:disabled{background:#ccc; cursor:not-allowed;}
.action-btn{font-size:11px; padding:5px 10px; margin-right:5px; background:#555;}
.action-btn:hover{background:#333;}

/* Tables */
.table-responsive{overflow-x:auto;}
.table{width:100%; border-collapse:collapse; margin-top:10px;}
.table th, .table td{border:1px solid #ddd; padding:8px; font-size:12px; text-align:center;}
.table th{background:#f8f9fa; color:#333;}

/* KPIs */
.kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
.kpi-box { padding: 15px; border-radius: 10px; text-align: center; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.kpi-title { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
.kpi-val { font-size: 24px; font-weight: bold; }

/* Dashboard Colors */
.bg-blue { background: linear-gradient(135deg, #0b66d2, #004c99); } /* Global */
.bg-green { background: linear-gradient(135deg, #28a745, #1e7e34); } /* 1st Floor */
.bg-orange { background: linear-gradient(135deg, #fd7e14, #d96205); } /* 2nd Floor */
.bg-purple { background: linear-gradient(135deg, #6f42c1, #553098); } /* Basement */

/* Modal */
.modal{display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:500px; background:#fff; padding:25px; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,0.3); z-index:1000;}
.overlay{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;}
</style>
</head>

<body>

<h2>üè≠ Quality Dashboard (Floor Wise)</h2>

<!-- GLOBAL & FLOOR DASHBOARD -->
<div class="card">
  <h3>üìä Overall Performance</h3>
  <div class="kpi-container">
     <div class="kpi-box bg-blue"><div class="kpi-title">Global Input</div><div class="kpi-val" id="g_inp">0</div></div>
     <div class="kpi-box bg-blue"><div class="kpi-title">Global FPY %</div><div class="kpi-val" id="g_fpy">--</div></div>
     <div class="kpi-box bg-blue"><div class="kpi-title">Global Rej %</div><div class="kpi-val" id="g_rej">--</div></div>
  </div>

  <h3>üè¢ Floor Wise Performance</h3>
  <div class="kpi-container">
     <!-- 1st Floor (Line 1-8) -->
     <div class="kpi-box bg-green">
        <div class="kpi-title">1st Floor (L 1-8)</div>
        <div class="kpi-title">FPY %</div>
        <div class="kpi-val" id="f1_fpy">--</div>
     </div>
     
     <!-- 2nd Floor (Line 9-16) -->
     <div class="kpi-box bg-orange">
        <div class="kpi-title">2nd Floor (L 9-16)</div>
        <div class="kpi-title">FPY %</div>
        <div class="kpi-val" id="f2_fpy">--</div>
     </div>

     <!-- Basement (Line 17-24) -->
     <div class="kpi-box bg-purple">
        <div class="kpi-title">Basement (L 17-24)</div>
        <div class="kpi-title">FPY %</div>
        <div class="kpi-val" id="fb_fpy">--</div>
     </div>
  </div>
</div>

<!-- DATA ENTRY FORM -->
<div class="card">
<h3>üìù Data Entry</h3>

<div class="form-row">
<div class="form-group"><label>Date</label><input type="date" id="f_date"></div>
<div class="form-group"><label>Shift</label><select id="f_shift"><option>A</option><option>B</option><option>C</option></select></div>
<div class="form-group"><label>Line (Enter Number only)</label><input type="number" id="f_line" placeholder="e.g. 5, 12, 20"></div>
<div class="form-group"><label>Model</label><input id="f_model"></div>
<div class="form-group"><label>Input Qty</label><input id="f_input" type="number" oninput="autoCalc()"></div>
<div class="form-group"><label>Defect Qty</label><input id="f_def" type="number" oninput="autoCalc()"></div>
<div class="form-group"><label>Rejection %</label><input id="f_rej" readonly></div>
<div class="form-group"><label>FPY %</label><input id="f_fpy" readonly></div>
</div>

<h4>Defect Bifurcation</h4>
<div class="form-row">
<div class="form-group"><label>RMD Qty</label><input id="rmd" oninput="autoCalc()"></div>
<div class="form-group"><label>RMD %</label><input id="rmd_r" readonly></div>
<div class="form-group"><label>Process Qty</label><input id="proc" oninput="autoCalc()"></div>
<div class="form-group"><label>Process %</label><input id="proc_r" readonly></div>
<div class="form-group"><label>SMT Qty</label><input id="smt" oninput="autoCalc()"></div>
<div class="form-group"><label>SMT %</label><input id="smt_r" readonly></div>
</div>

<h4>Top 3 Defects</h4>
<div class="form-row">
<div class="form-group"><label>Top-1 Defect</label><input id="d1"><input id="q1" placeholder="Qty"><input id="c1" placeholder="Cause"><input id="a1" placeholder="Action"></div>
</div>
<div class="form-row">
<div class="form-group"><label>Top-2 Defect</label><input id="d2"><input id="q2" placeholder="Qty"><input id="c2" placeholder="Cause"><input id="a2" placeholder="Action"></div>
</div>
<div class="form-row">
<div class="form-group"><label>Top-3 Defect</label><input id="d3"><input id="q3" placeholder="Qty"><input id="c3" placeholder="Cause"><input id="a3" placeholder="Action"></div>
</div>

<div class="form-row">
<div class="form-group"><label>Prepared By</label><input id="prep"></div>
<button onclick="saveData()" id="saveBtn">SAVE DATA</button>
</div>
</div>

<!-- FILTERS & TABLE -->
<div class="card">
<h3>üìÇ Records & Filters</h3>
<div class="form-row">
    <div class="form-group"><label>From</label><input type="date" id="flt_from"></div>
    <div class="form-group"><label>To</label><input type="date" id="flt_to"></div>
    <div class="form-group"><label>Line</label><input id="flt_line"></div>
    <div class="form-group"><label>&nbsp;</label><button onclick="applyFilter()">Apply Filter</button></div>
</div>

<div class="table-responsive">
<table class="table">
<thead><tr id="thead"></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<!-- PREVIEW MODAL -->
<div class="overlay" id="overlay"></div>
<div id="preview" class="modal"></div>

<script>
// ‚ö†Ô∏è APNA LATEST GOOGLE SCRIPT URL YAHAN PASTE KAREIN
const API = "https://script.google.com/macros/s/AKfycbyxl7XlRDxHhQ64dh6ZHOrctvufFmQeM3rjaS7_90JmuXJw8kG-PRS08Kh3VtaaU0fGAg/exec";

/* ---------------- CALCULATIONS ---------------- */
function autoCalc(){
 let i = +f_input.value || 0;
 let d = +f_def.value || 0;
 
 if(i > 0){
  f_rej.value = ((d/i)*100).toFixed(2);
  f_fpy.value = (100 - (d/i*100)).toFixed(2);
 } else {
  f_rej.value = ""; f_fpy.value = "";
 }
 
 rmd_r.value = i ? ((+rmd.value||0)/i*100).toFixed(2) : '';
 proc_r.value = i ? ((+proc.value||0)/i*100).toFixed(2) : '';
 smt_r.value = i ? ((+smt.value||0)/i*100).toFixed(2) : '';
}

/* ---------------- SAVE DATA ---------------- */
async function saveData(){
 const row = [
  f_date.value, f_shift.value, f_line.value, f_model.value,
  f_input.value, f_def.value, f_rej.value, f_fpy.value,
  rmd.value, rmd_r.value,
  proc.value, proc_r.value,
  smt.value, smt_r.value,
  d1.value, q1.value, c1.value, a1.value,
  d2.value, q2.value, c2.value, a2.value,
  d3.value, q3.value, c3.value, a3.value,
  prep.value
 ];

 // Validation: Line aur Input zaroori hai
 if(!f_line.value || !f_input.value) {
     alert("Please enter Line Number and Input Qty");
     return;
 }

 const btn = document.getElementById("saveBtn");
 btn.innerText = "Saving...";
 btn.disabled = true;

 try{
  const res = await fetch(API, {
   method: "POST",
   body: JSON.stringify({ action: "append", row: row })
  });

  const result = await res.json();

  if(result.status === "saved"){
    alert("‚úÖ Data Saved Successfully");
    
    // ‚úÖ Form Clear Karne ka Function Call
    clearForm(); 
    
    showPreview(row);
    load();
  } else {
    alert("‚ùå Save failed");
    console.log(result);
  }

 } catch(err){
  alert("‚ùå Error while saving. Check Internet.");
  console.error(err);
 } finally {
    btn.innerText = "SAVE DATA";
    btn.disabled = false;
 }
}

// ‚úÖ Form Clear Logic
function clearForm(){
  document.querySelectorAll('input').forEach(input => input.value = '');
  document.getElementById('f_shift').value = 'A'; // Reset shift to A
  // Date ko waisa hi rakhna hai to niche wali line hata dein
  // document.getElementById('f_date').value = ''; 
}

/* ---------------- PREVIEW ---------------- */
function showPreview(r){
 const p = document.getElementById('preview');
 const o = document.getElementById('overlay');
 
 p.innerHTML = `
 <h3>‚úÖ Saved Preview</h3>
 <p><b>Line:</b> ${r[2]} | <b>Floor:</b> ${getFloorName(r[2])}</p>
 <p><b>Input:</b> ${r[4]} | <b>Defect:</b> ${r[5]}</p>
 <p style="color:green; font-weight:bold;">FPY: ${r[7]}%</p>
 <button onclick="document.getElementById('preview').style.display='none';document.getElementById('overlay').style.display='none'">Close</button>
 `;
 p.style.display = "block";
 o.style.display = "block";
}

/* ---------------- FLOOR LOGIC ---------------- */
function getFloorName(lineNum) {
    let l = parseInt(lineNum) || 0;
    if (l >= 1 && l <= 8) return "1st Floor";
    if (l >= 9 && l <= 16) return "2nd Floor";
    if (l >= 17 && l <= 24) return "Basement";
    return "Unknown Floor";
}

/* ---------------- LOAD & DASHBOARD LOGIC ---------------- */
async function load(){
 try {
   const res = await fetch(API);
   const j = await res.json();
   const rows = j.rows;

   // Table Logic
   const t = tbody; const h = thead;
   t.innerHTML = ""; h.innerHTML = "";

   if(rows && rows.length > 0) {
     rows[0].forEach(x => h.innerHTML += `<th>${x}</th>`);
     // Add Floor Column Header
     h.innerHTML += `<th>Floor</th><th>Action</th>`;

     rows.slice(1).forEach((r, i) => {
      let tr = document.createElement("tr");
      r.forEach(c => tr.innerHTML += `<td>${c||""}</td>`);
      
      // Calculate Floor for this row
      let floor = getFloorName(r[2]); // Index 2 is Line
      tr.innerHTML += `<td><b>${floor}</b></td>`;

      tr.innerHTML += `<td><button class="action-btn" onclick="deleteRow(${i+1})">Del</button></td>`;
      t.appendChild(tr);
     });

     updateDashboard(rows.slice(1));
   }
 } catch(err) { console.error(err); }
}

function updateDashboard(rows){
 // Variables for Global
 let g_i=0, g_d=0;

 // Variables for Floors
 let f1_i=0, f1_d=0; // 1st Floor
 let f2_i=0, f2_d=0; // 2nd Floor
 let fb_i=0, fb_d=0; // Basement

 rows.forEach(r => {
    let line = parseInt(r[2]) || 0; // Column 2 is Line
    let inp = +r[4] || 0;           // Column 4 is Input
    let def = +r[5] || 0;           // Column 5 is Defect

    // Global Add
    g_i += inp; g_d += def;

    // Floor Wise Add
    if(line >= 1 && line <= 8) { f1_i += inp; f1_d += def; }
    else if(line >= 9 && line <= 16) { f2_i += inp; f2_d += def; }
    else if(line >= 17 && line <= 24) { fb_i += inp; fb_d += def; }
 });

 // Update UI Function
 const setKPI = (id, val) => document.getElementById(id).innerText = val;
 const calcFPY = (i, d) => i > 0 ? (100 - (d/i*100)).toFixed(2) + "%" : "--";
 const calcRej = (i, d) => i > 0 ? (d/i*100).toFixed(2) + "%" : "--";

 // Set Global
 setKPI('g_inp', g_i);
 setKPI('g_fpy', calcFPY(g_i, g_d));
 setKPI('g_rej', calcRej(g_i, g_d));

 // Set Floors
 setKPI('f1_fpy', calcFPY(f1_i, f1_d));
 setKPI('f2_fpy', calcFPY(f2_i, f2_d));
 setKPI('fb_fpy', calcFPY(fb_i, fb_d));
}

/* ---------------- DELETE & FILTER ---------------- */
async function deleteRow(i){
 if(confirm("Delete this record?")){
  await fetch(API, { method:'POST', body:JSON.stringify({action:'delete', rowIndex:i}) });
  load();
 }
}

function applyFilter(){
 let line = flt_line.value;
 let fd = flt_from.value; 
 let td = flt_to.value;
 
 let trs = tbody.querySelectorAll('tr');
 trs.forEach(tr => {
  let show = true;
  let rDate = tr.cells[0].innerText;
  let rLine = tr.cells[2].innerText;

  if(line && rLine !== line) show = false;
  if(fd && rDate < fd) show = false;
  if(td && rDate > td) show = false;
  
  tr.style.display = show ? '' : 'none';
 });
}

load();
</script>

</body>
</html>
