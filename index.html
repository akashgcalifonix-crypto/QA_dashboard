<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>PQC Dashboard System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Charts -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
/* --- CORE STYLES --- */
:root {
    --primary: #4f46e5; /* Modern Indigo */
    --secondary: #6366f1;
    --dark: #1e293b;
    --bg: #f3f4f6;
    --card-bg: #ffffff;
    
    /* Semantic Colors */
    --c-blue: #3b82f6;
    --c-red: #ef4444;
    --c-green: #10b981; 
    --c-orange: #f59e0b;
    --c-purple: #8b5cf6;
}

body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--dark); }

/* --- HEADER --- */
.header-box {
    background: white; padding: 15px 25px; border-radius: 12px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 25px; border-left: 5px solid var(--primary);
}
.app-logo { height: 40px; }
.app-title { font-size: 20px; font-weight: 800; margin-left: 15px; color: #111827; letter-spacing: -0.5px; }

/* --- NAVIGATION --- */
.nav-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; background: #e5e7eb; padding: 5px; border-radius: 12px; width: fit-content; margin: 0 auto 25px auto; }
.tab-btn {
    padding: 10px 25px; border: none; border-radius: 8px; cursor: pointer;
    font-weight: 600; font-size: 14px; color: #6b7280; background: transparent; transition: 0.2s;
}
.tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

/* --- DASHBOARD AESTHETICS (IMPROVED) --- */
.tab-content { display: none; animation: fadeIn 0.4s; }
.tab-content.active { display: block; }

/* Top Bar */
.dash-top-bar {
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
    background: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.date-filter-box { display: flex; gap: 10px; align-items: center; background: #f9fafb; padding: 8px 12px; border-radius: 6px; border: 1px solid #e5e7eb; }
.date-input { border: none; background: transparent; font-family: 'Inter'; font-size: 13px; color: #374151; outline: none; }

/* Floor Tabs */
.floor-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
.ft-btn {
    flex: 1; padding: 12px; border: 1px solid #e5e7eb; background: white; border-radius: 8px;
    cursor: pointer; font-weight: 600; text-align: center; transition: 0.2s; color: #6b7280;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.ft-btn:hover { border-color: var(--primary); color: var(--primary); background: #eef2ff; }
.ft-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); }

/* Modern KPI Grid */
.d-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
.kpi-modern {
    background: white; padding: 20px; border-radius: 12px; position: relative;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #f3f4f6;
    display: flex; flex-direction: column; justify-content: center;
}
.kpi-icon-box { 
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 18px; margin-bottom: 10px;
}
.kpi-val { font-size: 26px; font-weight: 800; color: #111827; line-height: 1.2; }
.kpi-lbl { font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
/* KPI Colors */
.k-blue .kpi-icon-box { background: #eff6ff; color: var(--c-blue); }
.k-green .kpi-icon-box { background: #ecfdf5; color: var(--c-green); }
.k-red .kpi-icon-box { background: #fef2f2; color: var(--c-red); }
.k-purple .kpi-icon-box { background: #f5f3ff; color: var(--c-purple); }

/* Chart Section */
.d-charts-row { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; margin-bottom: 25px; }
.d-chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #f3f4f6; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
.ch-title { font-size: 15px; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 8px; }
.ch-icon { color: var(--primary); }

/* Details Section */
.d-details-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.clean-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.clean-table th { text-align: left; padding: 12px; color: #9ca3af; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; font-weight: 600; }
.clean-table td { padding: 12px; border-bottom: 1px solid #f9fafb; color: #374151; font-weight: 500; }
.clean-table tr:last-child td { border-bottom: none; }

/* Progress Bars in Table */
.prog-track { width: 100%; background: #f3f4f6; height: 6px; border-radius: 10px; margin-top: 5px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 10px; }

/* --- ENTRY FORM & RECORDS (Kept Clean) --- */
.card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 25px; }
.form-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
.form-group { display: flex; flex-direction: column; flex: 1; min-width: 140px; }
label { font-size: 12px; font-weight: 600; color: #4b5563; margin-bottom: 5px; }
input, select { padding: 10px; border-radius: 8px; border: 1px solid #d1d5db; font-family: 'Inter'; outline: none; transition: 0.2s; }
input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: var(--primary); color: white; transition: 0.2s; }
button:hover { opacity: 0.9; transform: translateY(-1px); }

/* --- MODAL --- */
.overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 999; }
.modal-lg { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 900px; background: #fff; border-radius: 12px; z-index: 1000; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); overflow: hidden; animation: slideUp 0.3s; font-family: 'Inter', sans-serif; }
.pv-header { background: #f9fafb; padding: 15px 25px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
.pv-title { font-size: 18px; font-weight: 800; color: #111827; }
.pv-body { padding: 25px; max-height: 80vh; overflow-y: auto; background: #fff; }

/* Helper Classes */
.text-red { color: var(--c-red); font-weight: 700; }
.text-green { color: var(--c-green); font-weight: 700; }
.badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
.bg-light-red { background: #fef2f2; color: #991b1b; }

@keyframes slideUp { from { transform: translate(-50%, -45%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Record Search Preview */
.rec-preview-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
.rec-p-card { background: white; border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #e2e8f0; border-top: 4px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.rec-p-card.b-green { border-top-color: var(--c-green); }
.rec-p-card.b-red { border-top-color: var(--c-red); }
.rec-p-card.b-blue { border-top-color: var(--c-blue); }
.rec-p-card.b-purple { border-top-color: var(--c-purple); }
.rpc-lbl { font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; }
.rpc-val { font-size: 20px; font-weight: 800; color: #111827; margin-top: 5px; }

</style>
</head>
<body>

<!-- HEADER -->
<div class="header-box">
    <div style="display:flex; align-items:center;">
        <img id="mainLogo" src="" class="app-logo"> 
        <div class="app-title">PQC Management Dashboard</div>
    </div>
    <div style="font-size:12px; color:#6b7280; font-weight:600; text-align:right;">
        <div>Executive View</div>
        <div style="color:#111827;">Date: <span id="curDate"></span></div>
    </div>
</div>

<!-- TABS -->
<div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')"><i class="fa fa-chart-pie"></i> Analytics</button>
    <button class="tab-btn" onclick="switchTab('entry')"><i class="fa fa-pen-to-square"></i> Data Entry</button>
    <button class="tab-btn" onclick="switchTab('report')"><i class="fa fa-table"></i> Records</button>
</div>

<!-- TAB 1: DASHBOARD (IMPROVED LAYOUT) -->
<div id="dashboard" class="tab-content active">
    <!-- Filters -->
    <div class="dash-top-bar">
        <h3 style="margin:0; color:#111827; font-size:16px;">Production Overview</h3>
        <div style="display:flex; gap:10px; align-items:center;">
            <div class="date-filter-box">
                <span style="font-size:11px; font-weight:bold; color:#6b7280;">FROM</span>
                <input type="date" id="dash_from" class="date-input">
            </div>
            <div class="date-filter-box">
                <span style="font-size:11px; font-weight:bold; color:#6b7280;">TO</span>
                <input type="date" id="dash_to" class="date-input">
            </div>
            <button onclick="filterDashboard()" style="padding:8px 20px; font-size:13px; box-shadow:none;">Apply Filter</button>
        </div>
    </div>
    
    <!-- Floor Toggle -->
    <div class="floor-tabs">
        <div class="ft-btn active" onclick="switchDashTab('all', this)">Overall Plant</div>
        <div class="ft-btn" onclick="switchDashTab('1', this)">1st Floor</div>
        <div class="ft-btn" onclick="switchDashTab('2', this)">2nd Floor</div>
        <div class="ft-btn" onclick="switchDashTab('b', this)">Basement</div>
    </div>

    <div id="dash_content">
        <!-- Modern KPI Grid -->
        <div class="d-kpi-grid">
            <div class="kpi-modern k-blue">
                <div class="kpi-icon-box"><i class="fa fa-box-open"></i></div>
                <div class="kpi-val" id="d_inp">0</div>
                <div class="kpi-lbl">Total Verified Input</div>
            </div>
            <div class="kpi-modern k-green">
                <div class="kpi-icon-box"><i class="fa fa-check-circle"></i></div>
                <div class="kpi-val" id="d_fpy">--</div>
                <div class="kpi-lbl">Avg First Pass Yield</div>
            </div>
            <div class="kpi-modern k-red">
                <div class="kpi-icon-box"><i class="fa fa-triangle-exclamation"></i></div>
                <div class="kpi-val" id="d_def">0</div>
                <div class="kpi-lbl">Total Defect Volume</div>
            </div>
            <div class="kpi-modern k-purple">
                <div class="kpi-icon-box"><i class="fa fa-chart-line"></i></div>
                <div class="kpi-val" id="d_rej">--</div>
                <div class="kpi-lbl">Rejection Rate %</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="d-charts-row">
            <div class="d-chart-card">
                <div class="card-header">
                    <div class="ch-title"><i class="fa fa-chart-pie ch-icon"></i> Quality Composition</div>
                </div>
                <div id="d_pie" style="width:100%; height:250px;"></div>
            </div>
            <div class="d-chart-card">
                <div class="card-header">
                    <div class="ch-title"><i class="fa fa-chart-column ch-icon"></i> Stage Breakdown (Defect Rate %)</div>
                </div>
                <div id="d_bar" style="width:100%; height:250px;"></div>
            </div>
        </div>

        <!-- Details Tables -->
        <div class="d-details-row">
            <div class="d-chart-card">
                <div class="card-header">
                    <div class="ch-title"><i class="fa fa-list-ol ch-icon"></i> Top 5 Defects (Impact Analysis)</div>
                </div>
                <table class="clean-table">
                    <thead><tr><th>Defect Name</th><th>Qty</th><th>Defect Rate %</th></tr></thead>
                    <tbody id="d_defect_list"></tbody>
                </table>
            </div>
            <div class="d-chart-card">
                <div class="card-header">
                    <div class="ch-title"><i class="fa fa-layer-group ch-icon"></i> Stage Bifurcation Summary</div>
                </div>
                <table class="clean-table">
                    <thead><tr><th>Stage</th><th>Defect Qty</th><th>Defect Rate %</th></tr></thead>
                    <tbody id="d_process_body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- TAB 2: DATA ENTRY -->
<div id="entry" class="tab-content">
    <div class="card" id="entryForm">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #f3f4f6; padding-bottom:15px;">
            <h3 style="margin:0;">üìù New PQC Entry</h3>
            <button onclick="resetForm()" style="background:#f3f4f6; color:#6b7280; font-size:12px; box-shadow:none;">Reset Form</button>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Date</label><input type="date" id="f_date"></div>
            <div class="form-group"><label>Shift</label><select id="f_shift"><option>A</option><option>B</option><option>C</option></select></div>
            <div class="form-group"><label>Line No</label><input type="number" id="f_line" placeholder="1-24"></div>
            <div class="form-group"><label>Model</label><input id="f_model" placeholder="Enter Model"></div>
            <div class="form-group"><label>Input Qty</label><input id="f_input" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Defect Qty</label><input id="f_def" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Rej %</label><input id="f_rej" readonly></div>
            <div class="form-group"><label>FPY %</label><input id="f_fpy" readonly style="font-weight:700; color:#10b981;"></div>
        </div>
        
        <h4 style="color:#4b5563; margin-top:20px; font-size:14px; border-bottom:1px solid #eee; padding-bottom:5px;">Detailed Bifurcation</h4>
        <div class="form-row">
            <div class="form-group"><label>RMD Qty</label><input id="rmd" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>RMD %</label><input id="rmd_r" readonly></div>
            <div class="form-group"><label>Process Qty</label><input id="proc" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Process %</label><input id="proc_r" readonly></div>
            <div class="form-group"><label>SMT Qty</label><input id="smt" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>SMT %</label><input id="smt_r" readonly></div>
        </div>
        
        <h4 style="color:#4b5563; margin-top:20px; font-size:14px; border-bottom:1px solid #eee; padding-bottom:5px;">Top 3 Defects</h4>
        <datalist id="defect_list">
            <option value="Not On"><option value="Mic Fail"><option value="Speaker Fail"><option value="Channel Detection"><option value="Hard Glue"><option value="Body Sensor"><option value="RF Fail"><option value="Sensor Fail"><option value="Cavity Crack"><option value="Dut Mode"><option value="Dent, Scratch"><option value="Pogo Pin Issue"><option value="LED Issue"><option value="BT not connect"><option value="Buds Heating"><option value="Battery Drain"><option value="High Current"><option value="Inquiry Fail"><option value="Low Current"><option value="Low Sound"><option value="Electric Sound"><option value="Software PCBA"><option value="Polarity Reverse"><option value="Distortion"><option value="Key Issue"><option value="ANC Fail">
        </datalist>
        <div class="form-row">
            <div class="form-group"><label>Defect 1</label><input id="d1" list="defect_list" placeholder="Defect Name"><input id="q1" placeholder="Qty" type="number" style="margin-top:5px;"><input id="c1" placeholder="Cause" style="margin-top:5px;"><input id="a1" placeholder="Action" style="margin-top:5px;"></div>
            <div class="form-group"><label>Defect 2</label><input id="d2" list="defect_list" placeholder="Defect Name"><input id="q2" placeholder="Qty" type="number" style="margin-top:5px;"><input id="c2" placeholder="Cause" style="margin-top:5px;"><input id="a2" placeholder="Action" style="margin-top:5px;"></div>
            <div class="form-group"><label>Defect 3</label><input id="d3" list="defect_list" placeholder="Defect Name"><input id="q3" placeholder="Qty" type="number" style="margin-top:5px;"><input id="c3" placeholder="Cause" style="margin-top:5px;"><input id="a3" placeholder="Action" style="margin-top:5px;"></div>
        </div>
        <div class="form-row" style="margin-top:20px;">
            <div class="form-group"><label>Prepared By</label><input id="prep" placeholder="Enter Name"></div>
            <button onclick="saveData()" id="saveBtn" style="width:100%; margin-top:23px; height:45px;">SAVE RECORD</button>
        </div>
    </div>
</div>

<!-- TAB 3: RECORDS -->
<div id="report" class="tab-content">
    <div class="card">
        <h3>üìÇ Recorded Database</h3>
        <div style="background:#f9fafb; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #e5e7eb;">
            <div class="form-row">
                <div class="form-group" style="max-width: 140px;"><label>From</label><input type="date" id="date_from"></div>
                <div class="form-group" style="max-width: 140px;"><label>To</label><input type="date" id="date_to"></div>
                <div class="form-group" style="flex:2;"><label>Filter Lines</label><div id="lineSelectBox" style="border:1px solid #d1d5db; background:white; height:42px; overflow-y:auto; padding:5px; border-radius:8px;"></div></div>
                <div class="form-group" style="flex:1; justify-content: flex-end;"><button onclick="applyFilters()" style="margin-bottom:5px;">Search DB</button></div>
            </div>
        </div>

        <!-- NEW SEARCH PREVIEW CARDS IN RECORDS TAB -->
        <div id="rec_search_preview" class="rec-preview-row" style="display:none;">
            <div class="rec-p-card b-green"><div class="rpc-lbl">Avg FPY</div><div class="rpc-val" id="rp_fpy">--</div></div>
            <div class="rec-p-card b-red"><div class="rpc-lbl">Line Defect Rate</div><div class="rpc-val" id="rp_def">--</div></div>
            <div class="rec-p-card b-blue"><div class="rpc-lbl">SMT Defect Rate</div><div class="rpc-val" id="rp_smt">--</div></div>
            <div class="rec-p-card b-purple"><div class="rpc-lbl">RMD Defect Rate</div><div class="rpc-val" id="rp_rmd">--</div></div>
        </div>

        <div class="table-responsive">
            <table class="table"><thead><tr id="thead"></tr></thead><tbody id="tbody"></tbody></table>
            <div id="noDataMsg" style="text-align:center; padding:30px; display:none; color:#64748b;">No records found.</div>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div class="overlay" id="overlay"></div>
<div class="modal-lg" id="previewModal">
  <div class="pv-header">
      <div class="pv-logo-area" style="display:flex; align-items:center; gap:10px;">
          <img id="modalLogo" src="" style="height:35px;">
          <div><div class="pv-title">INSPECTION REPORT</div><div style="font-size:11px; color:#6b7280;">QMS Verification Record</div></div>
      </div>
      <button class="pv-close" onclick="closeModal()" style="background:none; border:none; color:#6b7280; font-size:18px; cursor:pointer;"><i class="fa fa-times"></i></button>
  </div>
  <div class="pv-body" id="previewContent"></div>
</div>

<script>
// --- CONFIGURATION ---
const API = "https://script.google.com/macros/s/AKfycbxR9xw1KJjLp0HUiHqyrSHgc4Ztt4HmWYNyfy8_tp50FubEaKbL36fJMQkjKNISQ_vXCA/exec";
const LOGO_URL = "https://i.postimg.cc/kRSbTd6w/logo.png"; 

document.getElementById('mainLogo').src = LOGO_URL;
document.getElementById('modalLogo').src = LOGO_URL;
document.getElementById('curDate').innerText = new Date().toLocaleDateString('en-IN');
google.charts.load('current', {'packages':['corechart']});

let allData = []; let editingRowIndex = null; let activeDashFloor = 'all';

function init() {
    const box = document.getElementById('lineSelectBox');
    let html = '<div style="display:flex; gap:10px; flex-wrap:wrap;">';
    for(let i=1; i<=24; i++){ html += `<label style="font-size:11px; display:flex; align-items:center; gap:3px;"><input type="checkbox" value="${i}" class="line-chk"> L${i}</label>`; }
    html += '</div>'; box.innerHTML = html;
    const today = new Date(); const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('dash_from').value = firstDay.toISOString().slice(0,10);
    document.getElementById('dash_to').value = today.toISOString().slice(0,10);
}
init();

function fixDate(dateValue) {
    if (!dateValue) return "";
    if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) return dateValue;
    let d = new Date(dateValue); if (isNaN(d.getTime())) return dateValue;
    return d.toLocaleDateString('en-CA');
}

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if(tabId==='dashboard') document.querySelectorAll('.tab-btn')[0].classList.add('active');
    if(tabId==='entry') document.querySelectorAll('.tab-btn')[1].classList.add('active');
    if(tabId==='report') document.querySelectorAll('.tab-btn')[2].classList.add('active');
}

function switchDashTab(floor, btn) {
    activeDashFloor = floor;
    document.querySelectorAll('.ft-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filterDashboard();
}

function filterDashboard() {
    if(!allData || allData.length === 0) return;
    const dFrom = document.getElementById('dash_from').value;
    const dTo = document.getElementById('dash_to').value;
    let dashRows = allData.slice(1).filter(r => {
        let rDate = fixDate(r[0]);
        return rDate >= dFrom && rDate <= dTo;
    });
    if(activeDashFloor !== 'all') {
        dashRows = dashRows.filter(r => {
            let line = parseInt(r[2]);
            if(activeDashFloor === '1') return line >= 1 && line <= 8;
            if(activeDashFloor === '2') return line >= 9 && line <= 16;
            if(activeDashFloor === 'b') return line >= 17 && line <= 24;
            return false;
        });
    }
    renderDashboardStats(dashRows);
}

// --- UPDATED LOGIC FOR DASHBOARD ---
function renderDashboardStats(rows) {
    let tInp = 0, tDef = 0, tRMD = 0, tProc = 0, tSMT = 0;
    let defectMap = {};
    rows.forEach(r => {
        tInp += (+r[4]||0); tDef += (+r[5]||0);
        tRMD += (+r[8]||0); tProc += (+r[10]||0); tSMT += (+r[12]||0);
        if(r[14]) defectMap[r[14]] = (defectMap[r[14]]||0) + (+r[15]||0);
        if(r[18]) defectMap[r[18]] = (defectMap[r[18]]||0) + (+r[19]||0);
        if(r[22]) defectMap[r[22]] = (defectMap[r[22]]||0) + (+r[23]||0);
    });
    let avgFpy = tInp > 0 ? (100 - (tDef/tInp*100)).toFixed(2) : "--";
    let avgRej = tInp > 0 ? (tDef/tInp*100).toFixed(2) : "--";
    document.getElementById('d_inp').innerText = tInp.toLocaleString();
    document.getElementById('d_def').innerText = tDef.toLocaleString();
    document.getElementById('d_fpy').innerText = avgFpy + "%";
    document.getElementById('d_rej').innerText = avgRej + "%";

    // UPDATED: Use Defect Rate % (Based on Total Input) instead of Contribution
    const getRate = (v) => tInp > 0 ? (v/tInp*100).toFixed(2)+"%" : "0.00%";
    const getRateVal = (v) => tInp > 0 ? (v/tInp*100) : 0;
    
    // Process Table
    let tableHtml = "";
    tableHtml += `<tr><td>RMD Stage</td><td class="text-red">${tRMD}</td><td><div class="badge bg-light-red">${getRate(tRMD)}</div></td></tr>`;
    tableHtml += `<tr><td>Process Stage</td><td class="text-red">${tProc}</td><td><div class="badge bg-light-red">${getRate(tProc)}</div></td></tr>`;
    tableHtml += `<tr><td>SMT Stage</td><td class="text-red">${tSMT}</td><td><div class="badge bg-light-red">${getRate(tSMT)}</div></td></tr>`;
    document.getElementById('d_process_body').innerHTML = tableHtml;

    // Top Defect List with Bars
    let sortedDefs = Object.entries(defectMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
    let defHtml = "";
    if(sortedDefs.length === 0) defHtml = "<tr><td colspan='3' style='text-align:center;color:#999;'>No defects found</td></tr>";
    else sortedDefs.forEach(d => { 
        let rate = getRate(d[1]);
        // Visual bar calculation relative to total defects for scaling, but displaying rate against input
        let barWidth = tDef > 0 ? (d[1]/tDef*100) : 0; 
        defHtml += `<tr>
            <td style="font-weight:600;">${d[0]}</td>
            <td>${d[1]}</td>
            <td>
                <div style="font-size:11px; font-weight:700;">${rate}</div>
                <div class="prog-track"><div class="prog-fill" style="width:${barWidth}%; background:var(--c-red);"></div></div>
            </td>
        </tr>`; 
    });
    document.getElementById('d_defect_list').innerHTML = defHtml;

    if(google && google.visualization && tInp > 0) {
        // Pie Chart
        var pieData = google.visualization.arrayToDataTable([['Type', 'Qty'], ['Good', tInp-tDef], ['Defects', tDef]]);
        new google.visualization.PieChart(document.getElementById('d_pie')).draw(pieData, {
            colors:['#10b981','#ef4444'], pieHole: 0.5, 
            chartArea:{width:'90%',height:'85%'}, legend:{position:'bottom'}
        });
        
        // Bar Chart (Rates against Input)
        let rmdR = getRateVal(tRMD); let procR = getRateVal(tProc); let smtR = getRateVal(tSMT);
        var barData = google.visualization.arrayToDataTable([
            ['Stage', 'Defect Rate %', { role: 'style' }, { role: 'annotation' }], 
            ['RMD', rmdR, '#3b82f6', rmdR.toFixed(2)+'%'], 
            ['Process', procR, '#8b5cf6', procR.toFixed(2)+'%'], 
            ['SMT', smtR, '#f59e0b', smtR.toFixed(2)+'%']
        ]);
        new google.visualization.ColumnChart(document.getElementById('d_bar')).draw(barData, {
            legend:'none', chartArea:{width:'85%',height:'75%'}, vAxis:{minValue:0, format:'#.##%'}
        });
    }
}

function autoCalc(){
    let i = +f_input.value || 0; let d = +f_def.value || 0;
    if(i > 0){ f_rej.value = ((d/i)*100).toFixed(2); f_fpy.value = (100 - (d/i*100)).toFixed(2); } 
    rmd_r.value = i ? ((+rmd.value||0)/i*100).toFixed(2) : '';
    proc_r.value = i ? ((+proc.value||0)/i*100).toFixed(2) : '';
    smt_r.value = i ? ((+smt.value||0)/i*100).toFixed(2) : '';
}

async function saveData(){
  if(!f_line.value || !f_input.value) { alert("‚ö†Ô∏è Line & Input Required!"); return; }
  const row = [f_date.value, f_shift.value, f_line.value, f_model.value, f_input.value, f_def.value, f_rej.value, f_fpy.value, rmd.value, rmd_r.value, proc.value, proc_r.value, smt.value, smt_r.value, d1.value, q1.value, c1.value, a1.value, d2.value, q2.value, c2.value, a2.value, d3.value, q3.value, c3.value, a3.value, prep.value];
  const btn = document.getElementById("saveBtn"); btn.innerText = "‚è≥ SAVING..."; btn.disabled = true;
  try {
     const action = editingRowIndex !== null ? "edit" : "append";
     const bodyData = { action: action, row: row, rowIndex: editingRowIndex };
     const res = await fetch(API, { method: "POST", body: JSON.stringify(bodyData) });
     const result = await res.json();
     if(result.status === "saved" || result.status === "updated"){ showDetailedPreview(row); load(); resetForm(); } 
  } catch(e) { alert("Error"); } finally { btn.innerText = "SAVE RECORD"; btn.disabled = false; }
}

function showDetailedPreview(r){
  const content = document.getElementById("previewContent");
  const d = fixDate(r[0]); 
  content.innerHTML = `
    <div class="pv-info-strip">
        <div class="pv-info-item"><div class="pv-lbl">DATE</div><div class="pv-val">${d}</div></div>
        <div class="pv-info-item"><div class="pv-lbl">SHIFT</div><div class="pv-val">${r[1]}</div></div>
        <div class="pv-info-item"><div class="pv-lbl">FLOOR / LINE</div><div class="pv-val">${getFloorName(r[2])} / L-${r[2]}</div></div>
        <div class="pv-info-item"><div class="pv-lbl">MODEL</div><div class="pv-val">${r[3]}</div></div>
        <div class="pv-info-item"><div class="pv-lbl">PREPARED BY</div><div class="pv-val">${r[26]}</div></div>
    </div>
    <div class="pv-kpi-row">
        <div class="pv-card pvc-blue"><div class="pvc-big-num">${r[4]}</div><div class="pvc-label">TOTAL INPUT</div></div>
        <div class="pv-card pvc-red"><div class="pvc-big-num">${r[5]}</div><div class="pvc-label">DEFECT QTY</div><div style="font-size:12px;">Rej Rate: ${r[6]}%</div></div>
        <div class="pv-card pvc-green"><div class="pvc-big-num">${r[7]}%</div><div class="pvc-label">FPY RATE</div></div>
    </div>
    <div class="pv-split">
        <div>
            <div class="pv-sec-title">‚ñå Process Bifurcation Details</div>
            <table class="pv-table">
                <thead><tr><th>Stage</th><th>Rejected Qty</th><th>Rejection %</th></tr></thead>
                <tbody>
                    <tr><td>RMD</td><td>${r[8]||0}</td><td>${r[9]||0}%</td></tr>
                    <tr><td>Process</td><td>${r[10]||0}</td><td>${r[11]||0}%</td></tr>
                    <tr><td>SMT</td><td>${r[12]||0}</td><td>${r[13]||0}%</td></tr>
                </tbody>
            </table>
            <div id="modal_mini_chart"></div>
        </div>
        <div>
            <div class="pv-sec-title">‚ñå Top 3 Defect Analysis</div>
            ${r[14] ? `<div class="pv-defect-box"><div class="pv-def-header"><span>1. ${r[14]}</span> <span>${r[15]} Nos</span></div><div class="pv-cause-action"><div>Cause: ${r[16]||'-'}</div><div>Action: ${r[17]||'-'}</div></div></div>` : ''}
            ${r[18] ? `<div class="pv-defect-box"><div class="pv-def-header"><span>2. ${r[18]}</span> <span>${r[19]} Nos</span></div><div class="pv-cause-action"><div>Cause: ${r[20]||'-'}</div><div>Action: ${r[21]||'-'}</div></div></div>` : ''}
            ${r[22] ? `<div class="pv-defect-box"><div class="pv-def-header"><span>3. ${r[22]}</span> <span>${r[23]} Nos</span></div><div class="pv-cause-action"><div>Cause: ${r[24]||'-'}</div><div>Action: ${r[25]||'-'}</div></div></div>` : ''}
        </div>
    </div>`;
  document.getElementById("overlay").style.display = 'block';
  document.getElementById("previewModal").style.display = 'block';
  setTimeout(() => { drawPreviewChart(r); }, 200);
}

function drawPreviewChart(r) {
    if(!google.visualization) return;
    var data = google.visualization.arrayToDataTable([['Stage', 'Qty', {role:'style'}], ['RMD', +r[8]||0, '#3b82f6'], ['Process', +r[10]||0, '#8b5cf6'], ['SMT', +r[12]||0, '#f59e0b']]);
    new google.visualization.ColumnChart(document.getElementById('modal_mini_chart')).draw(data, {legend:'none', chartArea:{width:'85%',height:'70%'}});
}

function editRow(idx) {
    let r = allData[idx]; editingRowIndex = idx;
    f_date.value=fixDate(r[0]); f_shift.value=r[1]; f_line.value=r[2]; f_model.value=r[3]; f_input.value=r[4]; f_def.value=r[5]; f_rej.value=r[6]; f_fpy.value=r[7];
    rmd.value=r[8]; rmd_r.value=r[9]; proc.value=r[10]; proc_r.value=r[11]; smt.value=r[12]; smt_r.value=r[13];
    d1.value=r[14]; q1.value=r[15]; c1.value=r[16]; a1.value=r[17]; d2.value=r[18]; q2.value=r[19]; c2.value=r[20]; a2.value=r[21]; d3.value=r[22]; q3.value=r[23]; c3.value=r[24]; a3.value=r[25]; prep.value=r[26];
    switchTab('entry'); document.getElementById("saveBtn").innerText = "UPDATE RECORD"; document.getElementById("saveBtn").style.background = "#f59e0b";
}

function applyFilters() {
    if(!allData || allData.length === 0) return;
    const dFrom = document.getElementById("date_from").value; const dTo = document.getElementById("date_to").value;
    const checkboxes = document.querySelectorAll('.line-chk:checked'); const selectedLines = Array.from(checkboxes).map(cb => cb.value);
    const t = document.getElementById('tbody'); const h = document.getElementById('thead'); t.innerHTML = ""; h.innerHTML = "";
    allData[0].forEach(x => h.innerHTML += `<th>${x}</th>`); h.innerHTML += `<th>Action</th>`;

    // Totals for Preview
    let sInp = 0, sDef = 0, sRMD = 0, sSMT = 0, count = 0;

    allData.slice(1).forEach((r, index) => {
        let rDate = fixDate(r[0]); let rLine = r[2].toString(); let match = true;
        if(dFrom && rDate < dFrom) match = false; if(dTo && rDate > dTo) match = false; if(selectedLines.length > 0 && !selectedLines.includes(rLine)) match = false;
        if(match) {
            count++; sInp += (+r[4]||0); sDef += (+r[5]||0); sRMD += (+r[8]||0); sSMT += (+r[12]||0);
            let tr = document.createElement("tr");
            r.forEach((c, i) => tr.innerHTML += `<td>${i===0 ? fixDate(c) : c||""}</td>`);
            let realIdx = index + 1;
            tr.innerHTML += `<td>
                <button onclick='showDetailedPreview(allData[${realIdx}])' style="padding:5px;"><i class="fa fa-eye"></i></button>
                <button onclick='editRow(${realIdx})' style="padding:5px; background:#f59e0b;"><i class="fa fa-edit"></i></button>
            </td>`;
            t.appendChild(tr);
        }
    });

    // Update Record Preview Cards
    const previewDiv = document.getElementById("rec_search_preview");
    if(count > 0) {
        previewDiv.style.display = 'grid';
        let dr = sInp > 0 ? (sDef/sInp*100).toFixed(2) : 0;
        document.getElementById("rp_fpy").innerText = (100 - dr).toFixed(2) + "%";
        document.getElementById("rp_def").innerText = dr + "%";
        document.getElementById("rp_smt").innerText = (sInp > 0 ? (sSMT/sInp*100).toFixed(2) : 0) + "%";
        document.getElementById("rp_rmd").innerText = (sInp > 0 ? (sRMD/sInp*100).toFixed(2) : 0) + "%";
    } else {
        previewDiv.style.display = 'none';
        document.getElementById("noDataMsg").style.display = 'block';
    }
}

async function load(){ try { const res = await fetch(API); const j = await res.json(); allData = j.rows; applyFilters(); filterDashboard(); } catch(e) {} }
function closeModal(){ document.getElementById("overlay").style.display='none'; document.getElementById("previewModal").style.display='none'; }
function getFloorName(l){ l = parseInt(l); if(l>=1 && l<=8) return "1st Floor"; if(l>=9 && l<=16) return "2nd Floor"; if(l>=17 && l<=24) return "Basement"; return "Other"; }
function resetForm(){ document.querySelectorAll('#entryForm input').forEach(i => i.value = ''); editingRowIndex = null; document.getElementById("saveBtn").innerText = "SAVE RECORD"; document.getElementById("saveBtn").style.background = "var(--primary)"; }

load();
</script>
</body>
</html>
