<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>TWS Rejection Outlook 8.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Charts -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<!-- SheetJS & PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- THEME & CORE --- */
:root {
    --primary: #2563eb;
    --bg-body: #f8fafc;
    --surface: #ffffff;
    --text-main: #0f172a;
    --text-light: #64748b;
    
    /* Stage Colors */
    --c-rmd: #3b82f6;   
    --c-proc: #8b5cf6;  
    --c-smt: #f59e0b;   
    
    --c-danger: #ef4444;
    --c-success: #10b981;
}

body { font-family: 'Manrope', sans-serif; background: var(--bg-body); margin: 0; padding: 20px; color: var(--text-main); -webkit-font-smoothing: antialiased; }

/* --- HEADER --- */
.header-box { background: var(--surface); padding: 15px 30px; border-radius: 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 25px; border-left: 6px solid var(--primary); }
.app-title { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; margin-left: 15px; color: var(--text-main); }

/* --- NAV --- */
.cat-switcher { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; background: #e2e8f0; padding: 5px; border-radius: 12px; width: fit-content; margin: 0 auto 25px auto; }
.cat-btn { padding: 10px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; color: var(--text-light); background: transparent; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
.cat-btn.active { background: var(--surface); color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }

.nav-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
.tab-btn { padding: 10px 30px; border: 1px solid #e2e8f0; border-radius: 30px; cursor: pointer; font-weight: 700; color: var(--text-light); background: var(--surface); transition: 0.3s; font-size: 14px; }
.tab-btn.active { background: var(--text-main); color: white; border-color: var(--text-main); box-shadow: 0 5px 15px rgba(30, 41, 59, 0.2); }

/* --- DASHBOARD COMPONENTS --- */
.dash-sub-nav { display: flex; gap: 5px; margin-bottom: 25px; background: #fff; padding: 5px; border-radius: 10px; border: 1px solid #e2e8f0; width: fit-content; }
.ds-btn { padding: 8px 20px; border: none; background: none; font-weight: 700; color: var(--text-light); cursor: pointer; font-size: 13px; border-radius: 8px; transition: 0.2s; }
.ds-btn.active { background: #eff6ff; color: var(--primary); }

.card { background: var(--surface); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); margin-bottom: 30px; border: 1px solid #f1f5f9; }
.dash-view { display: none; animation: fadeIn 0.4s; }
.dash-view.active { display: block; }

/* KPI Grid */
.mgmt-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
.kpi-modern { background: var(--surface); padding: 25px; border-radius: 16px; border: 1px solid #f1f5f9; display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); transition: transform 0.2s; }
.kpi-modern:hover { transform: translateY(-5px); border-color: var(--primary); }
.kpi-icon { width: 55px; height: 55px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
.kpi-val { font-size: 32px; font-weight: 800; color: var(--text-main); line-height: 1; margin-bottom: 5px; }
.kpi-lbl { font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
.k-blue .kpi-icon { background: #eff6ff; color: var(--primary); }
.k-green .kpi-icon { background: #ecfdf5; color: var(--c-success); }
.k-red .kpi-icon { background: #fef2f2; color: var(--c-danger); }
.k-purple .kpi-icon { background: #f5f3ff; color: var(--c-proc); }

/* Charts & Tables */
.mgmt-card { background: var(--surface); border-radius: 16px; padding: 25px; border: 1px solid #e2e8f0; height: 100%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
.mc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; }
.mc-title { font-size: 16px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
.mgmt-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.mgmt-table th { text-align: left; padding: 15px; color: var(--text-light); font-weight: 700; background: #f8fafc; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
.mgmt-table td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); font-weight: 600; }
.badge-rate { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 800; display: inline-block; min-width: 50px; text-align: center; }
.b-rmd { background: #eff6ff; color: var(--c-rmd); } .b-proc { background: #f5f3ff; color: var(--c-proc); } .b-smt { background: #fffbeb; color: var(--c-smt); } .b-high { background: #fef2f2; color: var(--c-danger); }

/* Layouts */
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; margin-bottom: 30px; }
.grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
.grid-1 { display: grid; grid-template-columns: 1fr; gap: 25px; margin-bottom: 30px; }
.grid-50 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
@media(max-width: 900px) { .grid-3, .grid-2, .grid-50, .mgmt-kpi-grid { grid-template-columns: 1fr; } }

/* Filters Bar */
.dash-top-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; background: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e2e8f0; }
.d-filter-group { display: flex; gap: 10px; align-items: center; background: #f8fafc; padding: 8px 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
.d-label { font-size: 11px; font-weight: 800; color: var(--text-light); }
.d-inp { border: none; background: transparent; font-size: 13px; font-weight: 700; outline: none; font-family: 'Manrope'; }

/* MULTI SELECT CUSTOM */
.multiselect { position: relative; display: inline-block; }
.selectBox { position: relative; }
.selectBox select { width: 100%; font-weight: 700; }
.overSelect { position: absolute; left: 0; right: 0; top: 0; bottom: 0; }
.checkboxes { display: none; border: 1px solid #ccc; width: 220px; max-height: 250px; overflow-y: scroll; position: absolute; z-index: 10; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 10px; }
.checkboxes label { display: block; padding: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-main); border-radius: 6px; }
.checkboxes label:hover { background-color: #f1f5f9; }

/* Form Styles */
.form-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
.form-group { display: flex; flex-direction: column; flex: 1; min-width: 150px; }
label { font-size: 11px; font-weight: 700; color: var(--text-light); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
input, select { padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; font-family: 'Manrope'; outline: none; font-size: 14px; font-weight: 600; background: #fff; transition: 0.2s; }
input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px #eff6ff; }
button { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; background: var(--primary); color: white; transition: 0.2s; font-size: 13px; }
button:hover { background: #1e40af; transform: translateY(-2px); }
.process-row { background: #f8fafc; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; align-items: center; margin-bottom: 12px; }
.remove-btn { background: var(--c-danger); width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; padding: 0; border-radius: 50%; color: white; box-shadow: 0 3px 8px rgba(220, 38, 38, 0.3); }
.prog-track { width: 100%; height: 8px; background: #f1f5f9; border-radius: 10px; margin-top: 8px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 10px; }

/* --- PREVIEW MODAL GAUGE STYLES --- */
.overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 999; }
.modal-lg { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 92%; max-width: 900px; background: #fff; border-radius: 20px; z-index: 1000; box-shadow: 0 25px 60px rgba(0,0,0,0.3); overflow: hidden; animation: slideUp 0.3s; }
.pv-header { padding: 25px 35px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
.pv-body { padding: 35px; max-height: 85vh; overflow-y: auto; background: #fbfbfc; }

.pv-meta-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
.pv-meta-item { text-align: center; border-right: 1px solid #f3f4f6; }
.pv-meta-item:last-child { border-right: none; }
.pv-label { font-size: 10px; font-weight: 800; color: #9ca3af; text-transform: uppercase; margin-bottom: 5px; }
.pv-value { font-size: 15px; font-weight: 800; color: #1f2937; }

/* GAUGES CONTAINER */
.pv-gauge-row { display: flex; justify-content: center; gap: 40px; margin-bottom: 30px; padding: 20px; background: #fff; border-radius: 16px; border: 1px solid #e5e7eb; }

/* STAGE CARDS */
.pv-stage-cards { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
.pv-scard { padding: 20px; border-radius: 16px; text-align: center; position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); transition: transform 0.2s; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
.pv-scard:hover { transform: translateY(-3px); }
.sc-blue { border-top: 4px solid var(--c-rmd); }
.sc-purple { border-top: 4px solid var(--c-proc); }
.sc-orange { border-top: 4px solid var(--c-smt); }
.sc-title { font-size: 12px; font-weight: 800; text-transform: uppercase; opacity: 0.6; letter-spacing: 1px; color: #64748b; margin-bottom: 5px; }
.sc-val { font-size: 28px; font-weight: 800; margin-bottom: 5px; color: #1e293b; }
.sc-rate { font-size: 14px; font-weight: 700; padding: 3px 10px; border-radius: 20px; display: inline-block; }

.pv-section-head { font-size: 14px; font-weight: 800; color: #374151; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
.pv-split { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
.pv-d-card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.2s; }
.pv-dc-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: 700; color: #1f2937; }
.pv-dc-badge { background: #f3f4f6; color: #4b5563; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; }
.pv-dc-content { font-size: 12px; color: #6b7280; line-height: 1.5; background: #f9fafb; padding: 10px; border-radius: 8px; }

/* Utils */
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.4s; }
.export-btn-group { display:flex; gap:10px; margin-bottom:15px; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUp { from { transform: translate(-50%, -45%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header-box">
    <div style="display:flex; align-items:center;">
        <img id="mainLogo" src="" style="height:40px;"> 
        <div class="app-title">TWS Rejection Outlook</div>
    </div>
    <div style="text-align:right;">
        <div style="font-size:11px; font-weight:700; color:var(--text-light); text-transform:uppercase;">Overview Date</div>
        <div style="font-size:14px; font-weight:800; color:var(--text-main);" id="curDate"></div>
    </div>
</div>

<!-- CATEGORY SWITCHER -->
<div class="cat-switcher">
    <button class="cat-btn active" id="btnEarbuds" onclick="switchCategory('Earbuds')">
        <i class="fa fa-headphones"></i> EARBUDS
    </button>
    <button class="cat-btn" id="btnCase" onclick="switchCategory('Charging Case')">
        <i class="fa fa-battery-full"></i> CHARGING CASE
    </button>
</div>

<!-- TABS -->
<div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')"><i class="fa fa-chart-pie"></i> Dashboard</button>
    <button class="tab-btn" onclick="switchTab('entry')"><i class="fa fa-pen-to-square"></i> Data Entry</button>
    <button class="tab-btn" onclick="switchTab('report')"><i class="fa fa-table"></i> Records</button>
</div>

<!-- TAB 1: DASHBOARD -->
<div id="dashboard" class="tab-content active">
    <div class="dash-container">
        <!-- Dashboard Content Same as Previous (Filters, KPI, Views) - Kept Clean for brevity -->
        <!-- DASHBOARD FILTERS -->
        <div class="dash-top-bar">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="margin:0; font-size:16px; font-weight:800;"><i class="fa fa-filter" style="color:var(--primary);"></i> Filters</h3>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <div class="d-filter-group"><span class="d-label">FROM</span><input type="date" id="dash_from" class="d-inp"></div>
                <div class="d-filter-group"><span class="d-label">TO</span><input type="date" id="dash_to" class="d-inp"></div>
                <div class="multiselect"><div class="selectBox" onclick="toggleCheckboxes()"><select class="d-inp" style="min-width:120px; padding:6px; border:1px solid #e5e7eb; border-radius:6px;"><option>Select Lines</option></select><div class="overSelect"></div></div><div id="checkboxes" class="checkboxes"></div></div>
                <div class="d-filter-group"><span class="d-label">MODEL</span><select id="dash_model" class="d-inp" style="min-width:80px;"><option value="all">All</option></select></div>
                <button onclick="filterDashboard()" style="padding:8px 15px; font-size:12px;">Apply</button>
                <button onclick="downloadDashboardPDF()" style="padding:8px 15px; font-size:12px; background:#b30b00;"><i class="fa fa-file-pdf"></i> PDF</button>
            </div>
        </div>

        <div class="mgmt-kpi-grid">
            <div class="kpi-modern k-blue"><div class="kpi-icon"><i class="fa fa-cubes"></i></div><div><div class="kpi-val" id="d_inp">0</div><div class="kpi-lbl">Total Input</div></div></div>
            <div class="kpi-modern k-green"><div class="kpi-icon"><i class="fa fa-check-circle"></i></div><div><div class="kpi-val" id="d_fpy">--</div><div class="kpi-lbl">Avg FPY %</div></div></div>
            <div class="kpi-modern k-red"><div class="kpi-icon"><i class="fa fa-bug"></i></div><div><div class="kpi-val" id="d_def">0</div><div class="kpi-lbl">Total Defects</div></div></div>
            <div class="kpi-modern k-purple"><div class="kpi-icon"><i class="fa fa-chart-line"></i></div><div><div class="kpi-val" id="d_rej">--</div><div class="kpi-lbl">Rejection Rate</div></div></div>
        </div>

        <div class="dash-sub-nav">
            <button class="ds-btn active" onclick="switchDashSubTab('overview', this)">üè† Overview</button>
            <button class="ds-btn" onclick="switchDashSubTab('line', this)">üè≠ Line Analysis</button>
            <button class="ds-btn" onclick="switchDashSubTab('model', this)">üëë Model Analysis</button>
            <button class="ds-btn" onclick="switchDashSubTab('floor', this)">üè¢ Floor Analysis</button>
        </div>

        <div id="view_overview" class="dash-view active">
            <div class="grid-50">
                <div class="mgmt-card"><div class="mc-header"><div class="mc-title"><i class="fa fa-cogs" style="color:var(--c-smt);"></i> Top 5 Process Defects</div></div><table class="mgmt-table"><thead><tr><th>Defect</th><th>Qty</th><th>Rate %</th></tr></thead><tbody id="d_process_defects_list"></tbody></table></div>
                <div class="mgmt-card"><div class="mc-header"><div class="mc-title"><i class="fa fa-bug" style="color:var(--c-danger);"></i> Top 3 Functional Defects</div></div><table class="mgmt-table"><thead><tr><th>Defect</th><th>Qty</th><th>Rate %</th></tr></thead><tbody id="d_functional_defects_list"></tbody></table></div>
            </div>
            <div class="grid-2">
                 <div class="mgmt-card"><div class="mc-header"><div class="mc-title"><i class="fa fa-chart-line" style="color:var(--primary);"></i> Daily Rejection Trend</div></div><div id="d_trend_chart" style="width:100%; height:300px;"></div></div>
                 <div class="mgmt-card"><div class="mc-header"><div class="mc-title"><i class="fa fa-chart-simple" style="color:var(--c-proc);"></i> Stage Defect Rates (%)</div></div><div id="d_bar" style="width:100%; height:300px;"></div></div>
            </div>
        </div>

        <div id="view_line" class="dash-view">
            <div class="grid-1"><div class="mgmt-card"><div class="mc-header"><div class="mc-title" style="color:var(--c-rmd);">Line Wise RMD Rate %</div></div><div id="d_line_rmd_chart" style="width:100%; height:300px;"></div></div></div>
            <div class="grid-1"><div class="mgmt-card"><div class="mc-header"><div class="mc-title" style="color:var(--c-proc);">Line Wise Process Rate %</div></div><div id="d_line_proc_chart" style="width:100%; height:300px;"></div></div></div>
            <div class="grid-1"><div class="mgmt-card"><div class="mc-header"><div class="mc-title" style="color:var(--c-smt);">Line Wise SMT Rate %</div></div><div id="d_line_smt_chart" style="width:100%; height:300px;"></div></div></div>
            <div class="grid-1"><div class="mgmt-card"><div class="mc-header"><div class="mc-title">Line Performance Table</div></div><div class="table-responsive"><table class="mgmt-table"><thead><tr><th>Line</th><th>Input</th><th>Defects</th><th>RMD %</th><th>Process %</th><th>SMT %</th><th>Total Rej %</th></tr></thead><tbody id="d_line_table_body"></tbody></table></div></div></div>
        </div>

        <div id="view_model" class="dash-view">
            <div class="grid-1"><div class="mgmt-card"><div class="mc-header"><div class="mc-title"><i class="fa fa-crown" style="color:var(--c-smt);"></i> Model Rejection Breakdown (Stacked Rate %)</div></div><div id="d_model_chart" style="width:100%; height:350px;"></div></div></div>
            <div class="grid-1"><div class="mgmt-card"><div class="mc-header"><div class="mc-title">Model Performance Table</div></div><div class="table-responsive" style="max-height:400px;"><table class="mgmt-table"><thead><tr><th>Model</th><th>Input</th><th>Defects</th><th>RMD %</th><th>Process %</th><th>SMT %</th><th>Total Rej %</th></tr></thead><tbody id="d_model_table_body"></tbody></table></div></div></div>
        </div>

        <div id="view_floor" class="dash-view">
            <div class="grid-3">
                <div class="mgmt-card"><div class="mc-header"><div class="mc-title" style="color:var(--c-rmd);">RMD Defect Rate</div></div><div id="d_floor_rmd_chart" style="width:100%; height:300px;"></div></div>
                <div class="mgmt-card"><div class="mc-header"><div class="mc-title" style="color:var(--c-proc);">Process Defect Rate</div></div><div id="d_floor_proc_chart" style="width:100%; height:300px;"></div></div>
                <div class="mgmt-card"><div class="mc-header"><div class="mc-title" style="color:var(--c-smt);">SMT Defect Rate</div></div><div id="d_floor_smt_chart" style="width:100%; height:300px;"></div></div>
            </div>
        </div>
    </div>
</div>

<!-- TAB 2: DATA ENTRY -->
<div id="entry" class="tab-content">
    <div class="card" id="entryForm">
        <!-- Entry Form Content (Kept as is) -->
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3 style="margin:0; font-size:18px;">üìù New PQC Entry (<span id="entryCatName" style="color:var(--primary);">Earbuds</span>)</h3>
            <button onclick="resetForm()" style="background:var(--text-light); font-size:11px;">Reset</button>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Date</label><input type="date" id="f_date"></div>
            <div class="form-group"><label>Shift</label><select id="f_shift"><option>A</option><option>B</option><option>C</option></select></div>
            <div class="form-group"><label>Line No</label><input type="number" id="f_line" placeholder="1-24"></div>
            <div class="form-group"><label>Model</label><input id="f_model" placeholder="Enter Model"></div>
            <div class="form-group"><label>Input Qty</label><input id="f_input" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Defect Qty</label><input id="f_def" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Rej %</label><input id="f_rej" readonly style="background:#f1f5f9;"></div>
            <div class="form-group"><label>FPY %</label><input id="f_fpy" readonly style="font-weight:700; color:var(--c-success); background:#f1f5f9;"></div>
        </div>
        <h4 style="margin:20px 0 10px 0; font-size:13px; color:var(--text-light); border-bottom:1px solid #e5e7eb;">Stage Breakdown</h4>
        <div class="form-row">
            <div class="form-group"><label>RMD Qty</label><input id="rmd" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>RMD %</label><input id="rmd_r" readonly></div>
            <div class="form-group"><label>Process Qty</label><input id="proc" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>Process %</label><input id="proc_r" readonly></div>
            <div class="form-group"><label>SMT Qty</label><input id="smt" type="number" oninput="autoCalc()"></div>
            <div class="form-group"><label>SMT %</label><input id="smt_r" readonly></div>
        </div>
        <datalist id="defect_list">
            <option value="Not On"><option value="Mic Fail"><option value="Speaker Fail"><option value="Channel Detection"><option value="Hard Glue"><option value="Body Sensor"><option value="RF Fail"><option value="Sensor Fail"><option value="Cavity Crack"><option value="Dut Mode"><option value="Dent, Scratch"><option value="Pogo Pin Issue"><option value="LED Issue"><option value="BT not connect"><option value="Buds Heating"><option value="Battery Drain"><option value="High Current"><option value="Inquiry Fail"><option value="Low Current"><option value="Low Sound"><option value="Electric Sound"><option value="Software PCBA"><option value="Polarity Reverse"><option value="Distortion"><option value="Key Issue"><option value="ANC Fail">
        </datalist>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:25px; border-bottom:1px solid #e5e7eb; padding-bottom:5px; margin-bottom:10px;">
            <h4 style="margin:0; font-size:13px; color:var(--c-smt);">Process Defects Breakup</h4>
            <button type="button" onclick="addProcessRow()" style="background:var(--c-success); padding:6px 12px; font-size:11px;"><i class="fa fa-plus"></i> Add Row</button>
        </div>
        <div id="process_container"></div>
        <h4 style="margin:25px 0 10px 0; font-size:13px; color:var(--c-danger); border-bottom:1px solid #e5e7eb;">Top 3 Functional Defects</h4>
        <div class="form-row">
            <div class="form-group"><label>Defect 1</label><input id="d1" list="defect_list" placeholder="Defect Name"><input id="q1" placeholder="Qty" type="number" style="margin-top:5px;"><input id="c1" placeholder="Cause" style="margin-top:5px;"><input id="a1" placeholder="Action" style="margin-top:5px;"></div>
            <div class="form-group"><label>Defect 2</label><input id="d2" list="defect_list" placeholder="Defect Name"><input id="q2" placeholder="Qty" type="number" style="margin-top:5px;"><input id="c2" placeholder="Cause" style="margin-top:5px;"><input id="a2" placeholder="Action" style="margin-top:5px;"></div>
            <div class="form-group"><label>Defect 3</label><input id="d3" list="defect_list" placeholder="Defect Name"><input id="q3" placeholder="Qty" type="number" style="margin-top:5px;"><input id="c3" placeholder="Cause" style="margin-top:5px;"><input id="a3" placeholder="Action" style="margin-top:5px;"></div>
        </div>
        <div class="form-row" style="margin-top:30px;">
            <div class="form-group"><label>Prepared By</label><input id="prep" placeholder="Enter Name"></div>
            <button onclick="saveData()" id="saveBtn" style="width:100%; margin-top:23px; height:45px; font-size:15px;">SAVE RECORD</button>
        </div>
    </div>
</div>

<!-- TAB 3: RECORDS -->
<div id="report" class="tab-content">
    <div class="card">
        <h3 style="margin-bottom:20px;">üìÇ Recorded Database</h3>
        <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid #e5e7eb;">
            <div class="form-row" style="margin-bottom:0;">
                <div class="form-group" style="max-width: 150px;"><label>From</label><input type="date" id="date_from"></div>
                <div class="form-group" style="max-width: 150px;"><label>To</label><input type="date" id="date_to"></div>
                <div class="form-group" style="flex:2;"><label>Filter Lines</label><div id="lineSelectBox" style="border:1px solid #cbd5e1; background:white; height:45px; overflow-y:auto; padding:8px; border-radius:8px;"></div></div>
                <div class="form-group" style="flex:1; justify-content: flex-end;"><label>&nbsp;</label><button onclick="applyFilters()" style="width:100%;">Search Records</button></div>
            </div>
        </div>
        <div class="export-btn-group" style="display:flex; gap:10px;">
            <button class="btn-excel" onclick="downloadExcel()" style="background:#107c41;"><i class="fa fa-file-excel"></i> Excel Export</button>
            <button class="btn-pdf" onclick="downloadPDF()" style="background:#b30b00;"><i class="fa fa-file-pdf"></i> PDF Export</button>
        </div>
        <div id="tableContainer" class="table-responsive">
            <table class="table" id="dataTable"><thead><tr id="thead"></tr></thead><tbody id="tbody"></tbody></table>
            <div id="noDataMsg" style="text-align:center; padding:40px; display:none; color:var(--text-light);">No records found matching criterea.</div>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div class="overlay" id="overlay"></div>
<div class="modal-lg" id="previewModal">
  <div class="pv-header">
      <div style="display:flex; align-items:center; gap:10px;">
          <img id="modalLogo" src="" style="height:35px;">
          <div><div style="font-weight:800; font-size:16px;">INSPECTION DETAILS</div><div style="font-size:11px; color:#64748b;">Daily Quality Report</div></div>
      </div>
      <button onclick="closeModal()" style="border:none; background:none; font-size:20px; cursor:pointer; color:#64748b;">&times;</button>
  </div>
  <div class="pv-body" id="previewContent"></div>
</div>

<script>
// --- CONFIGURATION ---
const API = "https://script.google.com/macros/s/AKfycbzuON-wm5hdXftPK1Q3WFvYP3DRsW45tZuxUAZvU55cBtL6pvDbzwI6GE8CryRdpaZ6iA/exec";
const LOGO_URL = "https://i.postimg.cc/kRSbTd6w/logo.png"; 

document.getElementById('mainLogo').src = LOGO_URL;
document.getElementById('modalLogo').src = LOGO_URL;
document.getElementById('curDate').innerText = new Date().toLocaleDateString('en-IN');
google.charts.load('current', {'packages':['corechart']});

let allData = []; 
let filteredData = []; 
let editingRowIndex = null; 
let currentCategory = "Earbuds"; 
let expandedLines = false;

function init() {
    const box = document.getElementById('lineSelectBox');
    let html = '<div style="display:flex; gap:8px; flex-wrap:wrap;">';
    for(let i=1; i<=24; i++){ html += `<label style="font-size:11px; display:flex; align-items:center; gap:4px; cursor:pointer;"><input type="checkbox" value="${i}" class="line-chk"> L${i}</label>`; }
    html += '</div>'; box.innerHTML = html;
    const dashBox = document.getElementById('checkboxes');
    let dHtml = '';
    for(let i=1; i<=24; i++){ dHtml += `<label><input type="checkbox" value="${i}" class="dash-line-chk" /> Line ${i}</label>`; }
    dashBox.innerHTML = dHtml;
    const today = new Date(); const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('dash_from').value = firstDay.toISOString().slice(0,10);
    document.getElementById('dash_to').value = today.toISOString().slice(0,10);
    addProcessRow(); 
}
init();

function toggleCheckboxes() {
  var checkboxes = document.getElementById("checkboxes");
  if (!expandedLines) { checkboxes.style.display = "block"; expandedLines = true; } 
  else { checkboxes.style.display = "none"; expandedLines = false; }
}

function addProcessRow(dVal="", qVal="", aVal="") {
    const div = document.createElement('div');
    div.className = 'process-row form-row';
    div.innerHTML = `
        <div class="form-group"><input class="pd-inp" list="defect_list" placeholder="Process Defect" value="${dVal}"></div>
        <div class="form-group"><input class="pq-inp" type="number" placeholder="Qty" value="${qVal}"></div>
        <div class="form-group" style="flex:2;"><input class="pa-inp" placeholder="Analysis" value="${aVal}"></div>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()"><i class="fa fa-times"></i></button>
    `;
    document.getElementById('process_container').appendChild(div);
}

function switchCategory(cat) {
    currentCategory = cat;
    document.getElementById('btnEarbuds').classList.remove('active');
    document.getElementById('btnCase').classList.remove('active');
    if(cat === 'Earbuds') document.getElementById('btnEarbuds').classList.add('active');
    else document.getElementById('btnCase').classList.add('active');
    document.getElementById('entryCatName').innerText = cat;
    allData = []; document.getElementById('tbody').innerHTML = ""; document.getElementById('d_inp').innerText = "...";
    load(); 
}

function fixDate(dateValue) {
    if (!dateValue) return "";
    if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) return dateValue;
    let d = new Date(dateValue); if (isNaN(d.getTime())) return dateValue;
    return d.toLocaleDateString('en-CA');
}

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if(tabId==='dashboard') document.querySelectorAll('.tab-btn')[0].classList.add('active');
    if(tabId==='entry') document.querySelectorAll('.tab-btn')[1].classList.add('active');
    if(tabId==='report') document.querySelectorAll('.tab-btn')[2].classList.add('active');
}

function switchDashSubTab(view, btn) {
    document.querySelectorAll('.dash-view').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.ds-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('view_'+view).classList.add('active');
    btn.classList.add('active');
}

function populateFilters() {
    let models = new Set();
    allData.slice(1).forEach(r => { if(r[3]) models.add(r[3]); });
    let mHtml = '<option value="all">All</option>';
    models.forEach(m => mHtml += `<option value="${m}">${m}</option>`);
    document.getElementById('dash_model').innerHTML = mHtml;
}

function filterDashboard() {
    if(!allData || allData.length === 0) { document.getElementById('d_inp').innerText = "0"; return; }
    const dFrom = document.getElementById('dash_from').value; const dTo = document.getElementById('dash_to').value; const sModel = document.getElementById('dash_model').value;
    const checkboxes = document.querySelectorAll('.dash-line-chk:checked'); const selectedLines = Array.from(checkboxes).map(cb => cb.value);
    let dashRows = allData.slice(1).filter(r => { 
        let rDate = fixDate(r[0]); let rLine = r[2].toString(); let rModel = r[3] || "";
        let dateMatch = rDate >= dFrom && rDate <= dTo;
        let lineMatch = selectedLines.length === 0 || selectedLines.includes(rLine);
        let modelMatch = sModel === 'all' || rModel === sModel;
        return dateMatch && lineMatch && modelMatch;
    });
    renderDashboardStats(dashRows);
}

function renderDashboardStats(rows) {
    let tInp = 0, tDef = 0, tRMD = 0, tProc = 0, tSMT = 0;
    let processDefectMap = {}; let functionalDefectMap = {}; let lineData = {}; let dateMap = {}; let modelData = {};
    let floorData = {'Floor 1':{inp:0,rmd:0,proc:0,smt:0}, 'Floor 2':{inp:0,rmd:0,proc:0,smt:0}, 'Basement':{inp:0,rmd:0,proc:0,smt:0}};

    rows.forEach(r => {
        let date = fixDate(r[0]); let line = r[2]; let model = r[3] || 'Unknown';
        let inp = (+r[4]||0); let def = (+r[5]||0); let rmdQ = (+r[8]||0); let procQ = (+r[10]||0); let smtQ = (+r[12]||0);
        tInp += inp; tDef += def; tRMD += rmdQ; tProc += procQ; tSMT += smtQ;
        if(r[14]) { let pNames = r[14].toString().split('\n'); let pQtys = r[15].toString().split('\n'); pNames.forEach((n, i) => { if(n) processDefectMap[n] = (processDefectMap[n]||0) + (+pQtys[i]||0); }); }
        if(r[17]) functionalDefectMap[r[17]] = (functionalDefectMap[r[17]]||0) + (+r[18]||0);
        if(r[21]) functionalDefectMap[r[21]] = (functionalDefectMap[r[21]]||0) + (+r[22]||0);
        if(r[25]) functionalDefectMap[r[25]] = (functionalDefectMap[r[25]]||0) + (+r[26]||0);
        const addToObj = (obj, key) => { if(!obj[key]) obj[key] = {inp:0, def:0, rmd:0, proc:0, smt:0}; obj[key].inp += inp; obj[key].def += def; obj[key].rmd += rmdQ; obj[key].proc += procQ; obj[key].smt += smtQ; };
        addToObj(lineData, line); addToObj(modelData, model);
        if(!dateMap[date]) dateMap[date] = {inp:0, def:0}; dateMap[date].inp += inp; dateMap[date].def += def;
        let lNum = parseInt(line);
        if(lNum >= 1 && lNum <= 8) { floorData['Floor 1'].inp += inp; floorData['Floor 1'].rmd += rmdQ; floorData['Floor 1'].proc += procQ; floorData['Floor 1'].smt += smtQ; }
        else if(lNum >= 9 && lNum <= 16) { floorData['Floor 2'].inp += inp; floorData['Floor 2'].rmd += rmdQ; floorData['Floor 2'].proc += procQ; floorData['Floor 2'].smt += smtQ; }
        else if(lNum >= 17 && lNum <= 24) { floorData['Basement'].inp += inp; floorData['Basement'].rmd += rmdQ; floorData['Basement'].proc += procQ; floorData['Basement'].smt += smtQ; }
    });

    let avgFpy = tInp > 0 ? (100 - (tDef/tInp*100)).toFixed(2) : "--"; let avgRej = tInp > 0 ? (tDef/tInp*100).toFixed(2) : "--";
    document.getElementById('d_inp').innerText = tInp.toLocaleString(); document.getElementById('d_def').innerText = tDef.toLocaleString();
    document.getElementById('d_fpy').innerText = avgFpy + "%"; document.getElementById('d_rej').innerText = avgRej + "%";
    const getRate = (v) => tInp > 0 ? (v/tInp*100).toFixed(2)+"%" : "0%";

    let sortedProcess = Object.entries(processDefectMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
    let pDefHtml = ""; sortedProcess.forEach(d => { let rate = getRate(d[1]); let barW = tDef > 0 ? (d[1]/tDef*100) : 0; pDefHtml += `<tr><td>${d[0]}</td><td><b>${d[1]}</b></td><td><div style="font-weight:700; font-size:12px; color:var(--c-smt);">${rate}</div></td></tr>`; });
    document.getElementById('d_process_defects_list').innerHTML = pDefHtml || "<tr><td colspan='3'>No Data</td></tr>";

    let sortedFunc = Object.entries(functionalDefectMap).sort((a,b)=>b[1]-a[1]).slice(0,3);
    let fDefHtml = ""; sortedFunc.forEach(d => { let rate = getRate(d[1]); fDefHtml += `<tr><td>${d[0]}</td><td><b>${d[1]}</b></td><td><div style="font-weight:700; font-size:12px; color:var(--c-danger);">${rate}</div></td></tr>`; });
    document.getElementById('d_functional_defects_list').innerHTML = fDefHtml || "<tr><td colspan='3'>No Data</td></tr>";

    if(google && google.visualization && tInp > 0) {
        let trendArr = [['Date', 'Rejection %', {role:'annotation'}]]; Object.keys(dateMap).sort().forEach(d => { let r = dateMap[d].inp > 0 ? (dateMap[d].def/dateMap[d].inp*100) : 0; trendArr.push([d, r, r.toFixed(1)+'%']); });
        new google.visualization.LineChart(document.getElementById('d_trend_chart')).draw(google.visualization.arrayToDataTable(trendArr), { legend:'none', pointSize:6, colors:['#2563eb'], chartArea:{width:'85%',height:'70%'}, vAxis:{format:'#.#'}, annotations:{alwaysOutside:true} });

        let rmdR = tInp > 0 ? (tRMD/tInp*100) : 0; let procR = tInp > 0 ? (tProc/tInp*100) : 0; let smtR = tInp > 0 ? (tSMT/tInp*100) : 0;
        new google.visualization.ColumnChart(document.getElementById('d_bar')).draw(google.visualization.arrayToDataTable([['Stage', 'Rate %', {role:'style'}, {role:'annotation'}], ['RMD', rmdR, '#3b82f6', rmdR.toFixed(2)+'%'], ['Process', procR, '#8b5cf6', procR.toFixed(2)+'%'], ['SMT', smtR, '#f59e0b', smtR.toFixed(2)+'%']]), { legend:'none', chartArea:{width:'85%',height:'75%'}, vAxis:{title:'Defect Rate %'} });

        let lineRMD = [['Line', 'Rate %', {role:'style'}, {role:'annotation'}]]; let lineProc = [['Line', 'Rate %', {role:'style'}, {role:'annotation'}]]; let lineSMT = [['Line', 'Rate %', {role:'style'}, {role:'annotation'}]]; let lineTableHtml = "";
        Object.keys(lineData).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(l => {
            let d = lineData[l]; let rr = d.inp > 0 ? (d.rmd/d.inp*100) : 0; let pr = d.inp > 0 ? (d.proc/d.inp*100) : 0; let sr = d.inp > 0 ? (d.smt/d.inp*100) : 0; let tot = rr+pr+sr;
            lineRMD.push(['L'+l, rr, '#3b82f6', rr.toFixed(1)+'%']); lineProc.push(['L'+l, pr, '#8b5cf6', pr.toFixed(1)+'%']); lineSMT.push(['L'+l, sr, '#f59e0b', sr.toFixed(1)+'%']);
            lineTableHtml += `<tr><td><b>L-${l}</b></td><td>${d.inp}</td><td>${d.def}</td><td><span class="badge-rate b-rmd">${rr.toFixed(2)}%</span></td><td><span class="badge-rate b-proc">${pr.toFixed(2)}%</span></td><td><span class="badge-rate b-smt">${sr.toFixed(2)}%</span></td><td><span class="badge-rate b-high">${tot.toFixed(2)}%</span></td></tr>`;
        });
        document.getElementById('d_line_table_body').innerHTML = lineTableHtml;
        new google.visualization.ColumnChart(document.getElementById('d_line_rmd_chart')).draw(google.visualization.arrayToDataTable(lineRMD), { legend:'none', vAxis:{title:'RMD %'}, chartArea:{width:'90%',height:'70%'} });
        new google.visualization.ColumnChart(document.getElementById('d_line_proc_chart')).draw(google.visualization.arrayToDataTable(lineProc), { legend:'none', vAxis:{title:'Proc %'}, chartArea:{width:'90%',height:'70%'} });
        new google.visualization.ColumnChart(document.getElementById('d_line_smt_chart')).draw(google.visualization.arrayToDataTable(lineSMT), { legend:'none', vAxis:{title:'SMT %'}, chartArea:{width:'90%',height:'70%'} });

        let modelArr = [['Model', 'RMD%', 'Proc%', 'SMT%', { role: 'annotation' }]]; let modelTableHtml = "";
        Object.entries(modelData).sort((a,b) => (b[1].def/b[1].inp) - (a[1].def/a[1].inp)).forEach(([m, d]) => {
            let rr = d.inp > 0 ? (d.rmd/d.inp*100) : 0; let pr = d.inp > 0 ? (d.proc/d.inp*100) : 0; let sr = d.inp > 0 ? (d.smt/d.inp*100) : 0; let tot = rr+pr+sr;
            modelArr.push([m, rr, pr, sr, tot.toFixed(1)+'%']);
            modelTableHtml += `<tr><td><b>${m}</b></td><td>${d.inp}</td><td>${d.def}</td><td><span class="badge-rate b-rmd">${rr.toFixed(2)}%</span></td><td><span class="badge-rate b-proc">${pr.toFixed(2)}%</span></td><td><span class="badge-rate b-smt">${sr.toFixed(2)}%</span></td><td><span class="badge-rate b-high">${tot.toFixed(2)}%</span></td></tr>`;
        });
        document.getElementById('d_model_table_body').innerHTML = modelTableHtml;
        new google.visualization.BarChart(document.getElementById('d_model_chart')).draw(google.visualization.arrayToDataTable(modelArr), { isStacked: true, colors:['#3b82f6', '#8b5cf6', '#f59e0b'], legend:{position:'bottom'}, chartArea:{width:'80%',height:'75%'}, hAxis:{title:'Rate %'} });

        let fRMD = [['Floor', 'Rate %', {role:'style'}, {role:'annotation'}]]; let fProc = [['Floor', 'Rate %', {role:'style'}, {role:'annotation'}]]; let fSMT = [['Floor', 'Rate %', {role:'style'}, {role:'annotation'}]];
        ['Floor 1', 'Floor 2', 'Basement'].forEach(f => {
            let d = floorData[f]; let rr = d.inp > 0 ? (d.rmd/d.inp*100) : 0; let pr = d.inp > 0 ? (d.proc/d.inp*100) : 0; let sr = d.inp > 0 ? (d.smt/d.inp*100) : 0;
            fRMD.push([f, rr, '#3b82f6', rr.toFixed(2)+'%']); fProc.push([f, pr, '#8b5cf6', pr.toFixed(2)+'%']); fSMT.push([f, sr, '#f59e0b', sr.toFixed(2)+'%']);
        });
        new google.visualization.ColumnChart(document.getElementById('d_floor_rmd_chart')).draw(google.visualization.arrayToDataTable(fRMD), { legend:'none', vAxis:{title:'RMD %'}, chartArea:{width:'80%',height:'75%'} });
        new google.visualization.ColumnChart(document.getElementById('d_floor_proc_chart')).draw(google.visualization.arrayToDataTable(fProc), { legend:'none', vAxis:{title:'Proc %'}, chartArea:{width:'80%',height:'75%'} });
        new google.visualization.ColumnChart(document.getElementById('d_floor_smt_chart')).draw(google.visualization.arrayToDataTable(fSMT), { legend:'none', vAxis:{title:'SMT %'}, chartArea:{width:'80%',height:'75%'} });
    } else { document.getElementById('d_bar').innerHTML = ""; }
}

function downloadDashboardPDF() {
    const dashboard = document.getElementById('dashboard'); const header = document.querySelector('.header-box'); document.querySelector('.dash-top-bar').style.display = 'none';
    let tempContainer = document.createElement('div'); tempContainer.appendChild(header.cloneNode(true)); tempContainer.appendChild(dashboard.cloneNode(true)); 
    var opt = { margin: 5, filename: 'TWS_Dashboard_Report.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
    html2pdf().set(opt).from(tempContainer).save().then(() => { document.querySelector('.dash-top-bar').style.display = 'flex'; });
}

function createGauge(value, title, isInverse) {
    const r = 80; const cx = 100; const cy = 100; const angle = Math.min(Math.max((value / 100) * 180 - 90, -90), 90);
    const color = isInverse ? (value < 2 ? '#10b981' : (value < 5 ? '#f59e0b' : '#ef4444')) : (value > 98 ? '#10b981' : (value > 95 ? '#f59e0b' : '#ef4444'));
    const rad = angle * (Math.PI / 180); const nx = cx + (r - 10) * Math.cos(rad); const ny = cy + (r - 10) * Math.sin(rad);
    return `<div style="text-align:center; width:200px;"><svg viewBox="0 0 200 110" style="width:100%;"><path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#e2e8f0" stroke-width="20" /><text x="15" y="100" font-size="10" fill="#94a3b8">0</text><text x="100" y="15" font-size="10" fill="#94a3b8" text-anchor="middle">50</text><text x="185" y="100" font-size="10" fill="#94a3b8">100</text><line x1="100" y1="100" x2="${nx}" y2="${ny}" stroke="#1e293b" stroke-width="4" stroke-linecap="round" /><circle cx="100" cy="100" r="6" fill="#1e293b" /><text x="100" y="80" font-size="18" font-weight="800" fill="${color}" text-anchor="middle">${value}%</text></svg><div style="font-size:12px; font-weight:700; color:#64748b; margin-top:-10px;">${title}</div></div>`;
}

function showDetailedPreview(r){
  const d = fixDate(r[0]); 
  let input = +r[4] || 1;
  let rejRate = (+r[6]||0);
  let fpyRate = (100 - rejRate).toFixed(2);
  
  let rmdR = ((+r[8]||0) / input * 100).toFixed(2);
  let procR = ((+r[10]||0) / input * 100).toFixed(2);
  let smtR = ((+r[12]||0) / input * 100).toFixed(2);

  let pHtml = "";
  if(r[14]) {
      let pNames = r[14].toString().split('\n'); let pQtys = r[15].toString().split('\n'); let pAnals = r[16].toString().split('\n');
      pNames.forEach((n, i) => { if(n) pHtml += `<div class="pv-defect-box" style="border-left:3px solid var(--c-proc);"><div style="display:flex;justify-content:space-between;font-weight:700;font-size:13px;"><span>${n}</span><span>Qty: ${pQtys[i]||0}</span></div><div style="font-size:11px;color:#666;margin-top:4px;">Analysis: ${pAnals[i]||'-'}</div></div>`; });
  }
  document.getElementById("previewContent").innerHTML = `
    <div class="pv-meta-grid">
        <div class="pv-meta-item"><div class="pv-label">Date</div><div class="pv-value">${d}</div></div>
        <div class="pv-meta-item"><div class="pv-label">Line</div><div class="pv-value">L-${r[2]}</div></div>
        <div class="pv-meta-item"><div class="pv-label">Model</div><div class="pv-value">${r[3]}</div></div>
        <div class="pv-meta-item"><div class="pv-label">Shift</div><div class="pv-value">${r[1]}</div></div>
        <div class="pv-meta-item"><div class="pv-label">User</div><div class="pv-value">${r[29]}</div></div>
    </div>
    
    <div class="pv-gauge-row">
        ${createGauge(rejRate, 'Rejection Rate', true)}
        ${createGauge(fpyRate, 'First Pass Yield', false)}
    </div>

    <div class="pv-section-head"><i class="fa fa-chart-pie" style="color:var(--primary);"></i> Stage Analysis</div>
    <div class="pv-stage-cards">
        <div class="pv-scard sc-blue">
            <div class="sc-title">RMD</div>
            <div class="sc-val">${r[8]||0}</div>
            <div class="sc-sub"><span class="sc-rate" style="background:#eff6ff; color:#3b82f6;">${rmdR}%</span></div>
        </div>
        <div class="pv-scard sc-purple">
            <div class="sc-title">Process</div>
            <div class="sc-val">${r[10]||0}</div>
            <div class="sc-sub"><span class="sc-rate" style="background:#f5f3ff; color:#8b5cf6;">${procR}%</span></div>
        </div>
        <div class="pv-scard sc-orange">
            <div class="sc-title">SMT</div>
            <div class="sc-val">${r[12]||0}</div>
            <div class="sc-sub"><span class="sc-rate" style="background:#fff7ed; color:#f59e0b;">${smtR}%</span></div>
        </div>
    </div>

    <div class="pv-split">
        <div><h4 class="pv-section-head" style="color:var(--c-proc); border-color:var(--c-proc);"><i class="fa fa-cogs"></i> Process Breakdown</h4>${pHtml}</div>
        <div><h4 class="pv-section-head" style="color:var(--c-danger); border-color:var(--c-danger);"><i class="fa fa-bug"></i> Top Functional Defects</h4>
            ${r[17] ? `<div class="pv-d-card"><div class="pv-dc-top"><span>#1 ${r[17]}</span><span class="pv-dc-badge">${r[18]}</span></div><div class="pv-dc-content"><b>Cause:</b> ${r[19]}<br><b>Action:</b> ${r[20]}</div></div>` : ''}
            ${r[21] ? `<div class="pv-d-card"><div class="pv-dc-top"><span>#2 ${r[21]}</span><span class="pv-dc-badge">${r[22]}</span></div><div class="pv-dc-content"><b>Cause:</b> ${r[23]}<br><b>Action:</b> ${r[24]}</div></div>` : ''}
            ${r[25] ? `<div class="pv-d-card"><div class="pv-dc-top"><span>#3 ${r[25]}</span><span class="pv-dc-badge">${r[26]}</span></div><div class="pv-dc-content"><b>Cause:</b> ${r[27]}<br><b>Action:</b> ${r[28]}</div></div>` : ''}
        </div>
    </div>`;
  document.getElementById("overlay").style.display = 'block'; document.getElementById("previewModal").style.display = 'block';
}

function autoCalc(){
    let i = +f_input.value || 0; let d = +f_def.value || 0;
    if(i > 0){ f_rej.value = ((d/i)*100).toFixed(2); f_fpy.value = (100 - (d/i*100)).toFixed(2); } 
    rmd_r.value = i ? ((+rmd.value||0)/i*100).toFixed(2) : '';
    proc_r.value = i ? ((+proc.value||0)/i*100).toFixed(2) : '';
    smt_r.value = i ? ((+smt.value||0)/i*100).toFixed(2) : '';
}

async function saveData(){
  if(!f_line.value || !f_input.value) { alert("‚ö†Ô∏è Line & Input Required!"); return; }
  const pNames = Array.from(document.querySelectorAll('.pd-inp')).map(i => i.value).join('\n');
  const pQtys = Array.from(document.querySelectorAll('.pq-inp')).map(i => i.value).join('\n');
  const pAnals = Array.from(document.querySelectorAll('.pa-inp')).map(i => i.value).join('\n');
  const row = [f_date.value, f_shift.value, f_line.value, f_model.value, f_input.value, f_def.value, f_rej.value, f_fpy.value, rmd.value, rmd_r.value, proc.value, proc_r.value, smt.value, smt_r.value, pNames, pQtys, pAnals, d1.value, q1.value, c1.value, a1.value, d2.value, q2.value, c2.value, a2.value, d3.value, q3.value, c3.value, a3.value, prep.value];
  const btn = document.getElementById("saveBtn"); btn.innerText = "‚è≥ SAVING..."; btn.disabled = true;
  try {
     const res = await fetch(API, { method: "POST", body: JSON.stringify({ sheet: currentCategory, action: editingRowIndex !== null ? "edit" : "append", row: row, rowIndex: editingRowIndex }) });
     const result = await res.json();
     if(result.status === "saved" || result.status === "updated"){ showDetailedPreview(row); load(); resetForm(); } 
  } catch(e) { alert("Error saving"); } finally { btn.innerText = "SAVE RECORD"; btn.disabled = false; }
}

async function deleteRow(idx) {
    if(!confirm("DELETE record?")) return;
    try { const res = await fetch(API, { method: "POST", body: JSON.stringify({ sheet: currentCategory, action: "delete", rowIndex: idx }) }); load(); } catch(e) { alert("Network Error"); }
}

function editRow(idx) {
    let r = allData[idx]; editingRowIndex = idx;
    f_date.value=fixDate(r[0]); f_shift.value=r[1]; f_line.value=r[2]; f_model.value=r[3]; f_input.value=r[4]; f_def.value=r[5]; f_rej.value=r[6]; f_fpy.value=r[7];
    rmd.value=r[8]; rmd_r.value=r[9]; proc.value=r[10]; proc_r.value=r[11]; smt.value=r[12]; smt_r.value=r[13];
    document.getElementById('process_container').innerHTML = '';
    if(r[14]) { let pNames = r[14].toString().split('\n'); let pQtys = r[15].toString().split('\n'); let pAnals = r[16].toString().split('\n'); pNames.forEach((n, i) => addProcessRow(n, pQtys[i], pAnals[i])); } else { addProcessRow(); }
    d1.value=r[17]; q1.value=r[18]; c1.value=r[19]; a1.value=r[20]; d2.value=r[21]; q2.value=r[22]; c2.value=r[23]; a2.value=r[24]; d3.value=r[25]; q3.value=r[26]; c3.value=r[27]; a3.value=r[28]; prep.value=r[29];
    switchTab('entry'); document.getElementById("saveBtn").innerText = "UPDATE RECORD"; document.getElementById("saveBtn").style.background = "#f59e0b";
}

function applyFilters() {
    if(!allData || allData.length === 0) { document.getElementById('tbody').innerHTML = ""; return; }
    const dFrom = document.getElementById("date_from").value; const dTo = document.getElementById("date_to").value;
    const checkboxes = document.querySelectorAll('.line-chk:checked'); const selectedLines = Array.from(checkboxes).map(cb => cb.value);
    const t = document.getElementById('tbody'); const h = document.getElementById('thead'); t.innerHTML = ""; h.innerHTML = "";
    allData[0].forEach(x => h.innerHTML += `<th>${x}</th>`); h.innerHTML += `<th>Action</th>`;
    filteredData = [allData[0]]; 
    allData.slice(1).forEach((r, index) => {
        let rDate = fixDate(r[0]); let rLine = r[2].toString(); let match = true;
        if(dFrom && rDate < dFrom) match = false; if(dTo && rDate > dTo) match = false; if(selectedLines.length > 0 && !selectedLines.includes(rLine)) match = false;
        if(match) {
            filteredData.push(r); let tr = document.createElement("tr");
            r.forEach((c, i) => tr.innerHTML += `<td>${i===0 ? fixDate(c) : c||""}</td>`);
            let realIdx = index + 1;
            tr.innerHTML += `<td><button onclick='showDetailedPreview(allData[${realIdx}])' style="padding:6px; margin-right:5px; background:var(--c-proc); border-radius:5px; color:white;"><i class="fa fa-eye"></i></button><button onclick='editRow(${realIdx})' style="padding:6px; background:var(--c-smt); border-radius:5px; margin-right:5px; color:white;"><i class="fa fa-edit"></i></button><button onclick='deleteRow(${realIdx})' style="padding:6px; background:var(--c-danger); border-radius:5px; color:white;"><i class="fa fa-trash"></i></button></td>`;
            t.appendChild(tr);
        }
    });
}

function downloadExcel() { if(filteredData.length <= 1) { alert("No data"); return; } var ws = XLSX.utils.aoa_to_sheet(filteredData); var wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "PQC_Data.xlsx"); }
function downloadPDF() { const el = document.getElementById('tableContainer'); if(!el) return; html2pdf().set({ margin: 5, filename: 'PQC_Report.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } }).from(el).save(); }
async function load(){ try { const res = await fetch(API + "?sheet=" + currentCategory); const j = await res.json(); allData = j.rows; populateFilters(); applyFilters(); filterDashboard(); } catch(e) { console.error(e); } }
function closeModal(){ document.getElementById("overlay").style.display='none'; document.getElementById("previewModal").style.display='none'; }
function resetForm(){ document.querySelectorAll('#entryForm input').forEach(i => i.value = ''); editingRowIndex = null; document.getElementById("saveBtn").innerText = "SAVE RECORD"; document.getElementById("saveBtn").style.background = "var(--primary)"; document.getElementById('process_container').innerHTML = ''; addProcessRow(); }

function toggleCheckboxes() {
  var checkboxes = document.getElementById("checkboxes");
  checkboxes.style.display = (checkboxes.style.display === "block") ? "none" : "block";
}

load();
</script>
</body>
</html>
